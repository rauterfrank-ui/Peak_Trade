groups:
  - name: ai_live_ops_pack_v1
    rules:
      - alert: AI_LIVE_ExporterDown
        expr: up{job="ai_live"} == 0
        for: 1m
        labels:
          severity: page
          component: ai_live
        annotations:
          summary: "AI Live Exporter ist DOWN (job=ai_live)"
          description: |
            Prometheus scrapt den AI Live Exporter nicht (up==0).
            Port Contract v1: Exporter läuft watch-only lokal auf :9110 (host.docker.internal:9110).

            Checks:
            - Prometheus targets: http://127.0.0.1:9092/targets (job="ai_live")
            - Exporter direkt: http://127.0.0.1:9110/metrics
            - Port-Konflikt: lsof -nP -iTCP:9110 -sTCP:LISTEN

      - alert: AI_LIVE_StaleEvents
        expr: clamp_min(time() - max by (source) (peaktrade_ai_last_event_timestamp_seconds), 0) > 60
        for: 2m
        labels:
          severity: warn
          component: ai_live
        annotations:
          summary: "AI Live Events stale (source={{ $labels.source }})"
          description: |
            Der Exporter läuft evtl., aber es kommen keine frischen Events an.
            "source" zeigt das Event-Format / den Producer (z.B. sample_v1, beta_exec_v1).

            Checks:
            - Event-Writer/Emitter läuft noch?
            - JSONL-Pfad stimmt? (PEAK_TRADE_AI_EVENTS_JSONL)
            - Grafana: Execution Watch Overview → AI Live (freshness panels)

      - alert: AI_LIVE_ParseErrorsSpike
        expr: (sum(rate(peaktrade_ai_events_parse_errors_total[5m])) or on() vector(0)) > 0
        for: 2m
        labels:
          severity: warn
          component: ai_live
        annotations:
          summary: "AI Live Parse Errors spike (5m)"
          description: |
            Es treten JSON/Parse-Probleme auf (rate(parse_errors_total) > 0).
            Typisch: ungültiges JSON, beschädigte Zeilen, Format-Drift.

      - alert: AI_LIVE_DroppedEventsSpike
        expr: (sum(rate(peaktrade_ai_events_dropped_total[5m])) or on() vector(0)) > 0
        for: 2m
        labels:
          severity: warn
          component: ai_live
        annotations:
          summary: "AI Live Drops spike (5m)"
          description: |
            Events werden gedroppt (rate(dropped_total) > 0).
            Häufige reasons: bad_json, missing_fields, unknown_schema.

      - alert: AI_LIVE_LatencyP95High
        expr: histogram_quantile(0.95, sum(rate(peaktrade_ai_decision_latency_ms_bucket[5m])) by (le)) > 250
        for: 5m
        labels:
          severity: warn
          component: ai_live
        annotations:
          summary: "AI Live Decision Latency p95 > 250ms (5m)"
          description: |
            p95 Latenz der Decisions ist erhöht.
            Tuning: Thresholds sind konservativ; adjustiere nach Baseline/Traffic.

      - alert: AI_LIVE_LatencyP99High
        expr: histogram_quantile(0.99, sum(rate(peaktrade_ai_decision_latency_ms_bucket[5m])) by (le)) > 500
        for: 5m
        labels:
          severity: warn
          component: ai_live
        annotations:
          summary: "AI Live Decision Latency p99 > 500ms (5m)"
          description: |
            p99 Latenz der Decisions ist stark erhöht (Tail-Latency).
