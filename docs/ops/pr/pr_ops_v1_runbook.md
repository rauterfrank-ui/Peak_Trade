# PR Ops v1 Runbook

## Purpose

Standardize three helper scripts generated by `p41_kickoff_scaffold_v1.sh --with-pr-ops`:

- `<pNN>_pr_watch.sh`: poll PR state and write evidence on MERGED
- `<pNN>_oneshot_closeout.sh`: run closeout after merge (main sync + evidence + tarball + sha256)
- `<pNN>_required_checks_snapshot.sh`: capture PR checks + branch protection required contexts

These scripts are safe-by-default and **best-effort** when branch protection APIs are inaccessible.

## Generate

Example:

```bash
TS="$(date -u +%Y%m%dT%H%M%SZ)"
./scripts/ops/p41_kickoff_scaffold_v1.sh p44 <topic> --ts "$TS" --with-pr-ops
```

This creates `scripts&#47;ops&#47;p44_pr_watch.sh`, `p44_oneshot_closeout.sh`, and `p44_required_checks_snapshot.sh`.

## Scripts

### Single entrypoint (recommended)

```bash
# uses gh; optional TLS wrapper: alias gh='scripts/ops/gh_tls_wrap.sh'
./scripts/ops/pr_ops_v1.sh <PR_NUM>
```

**Usage:**
- snapshots view+checks
- waits required checks
- retriggers once only if "Expected/Waiting for status" appears
- on merge: sync main + closeout evidence + tarball

### 1. PR Watch (`<pNN>_pr_watch.sh`)

Polls PR state via `gh pr view` every 15s until MERGED (max ~1h). On MERGED, writes evidence to `out&#47;ops&#47;pr<N>_watch_<TS>&#47;`.

**Usage:**

```bash
./scripts/ops/<pNN>_pr_watch.sh <PR_NUM>           # foreground
./scripts/ops/<pNN>_pr_watch.sh <PR_NUM> --bg     # background
```

**Evidence:** `PR_VIEW.json`, `PR_CHECKS.txt`, `STATUS.txt`, `HEAD.txt`, `LOG5.txt`, `SHA256SUMS.txt`

### 2. One-shot Closeout (`<pNN>_oneshot_closeout.sh`)

Runs **after** PR is merged. Syncs main, writes evidence, creates tarball + sha256.

**Usage:**

```bash
./scripts/ops/<pNN>_oneshot_closeout.sh <PR_NUM>
```

**Guard:** Exits with code 3 if PR is not yet MERGED.

**Evidence:** `out&#47;ops&#47;pr<N>_closeout_<TS>&#47;` + `*.bundle.tgz` + `*.sha256`

### 3. Required Checks Snapshot (`<pNN>_required_checks_snapshot.sh`)

Captures PR view, checks, and (best-effort) branch protection required contexts.

**Usage:**

```bash
./scripts/ops/<pNN>_required_checks_snapshot.sh <PR_NUM>
```

**Evidence:** `out&#47;ops&#47;pr<N>_required_checks_<TS>&#47;`

## Typical Flow

1. Open PR, enable auto-merge
2. Run `.&#47;scripts&#47;ops&#47;<pNN>_pr_watch.sh <PR_NUM> --bg` (optional)
3. After merge: `.&#47;scripts&#47;ops&#47;<pNN>_oneshot_closeout.sh <PR_NUM>`
4. For debugging checks: `.&#47;scripts&#47;ops&#47;<pNN>_required_checks_snapshot.sh <PR_NUM>`

## Canonical entrypoint (recommended)

Use the single entrypoint:

- `scripts&#47;ops&#47;pr_ops_v1.sh <PR_NUM>`

It can:
- snapshot PR view/checks
- `--watch` required checks
- (optional) one-time retrigger on "Expected — Waiting for status to be reported"
- closeout after merge (main sync + evidence + bundle)

## Legacy scripts (deprecated)

The older per-PR scripts are kept for reference, but **new work should use `pr_ops_v1.sh`**:

- `*_pr_watch.sh`
- `*_oneshot_closeout.sh`
- `*_required_checks_snapshot.sh`

If you generated these from scaffolds, prefer switching to:

- `scripts&#47;ops&#47;pr_ops_v1.sh <PR_NUM> [--watch] [--retrigger-on-waiting] [--closeout] [--bundle]`

## See Also

- [P43 — CI Ops Scaffold Extend](../../analysis/p43/README.md)
- [p41 Kickoff Scaffold](../../../scripts/ops/p41_kickoff_scaffold_v1.sh)
