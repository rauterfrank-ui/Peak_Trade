name: paper-session-telemetry-summary

on:
  workflow_dispatch:
    inputs:
      spec:
        description: "Paper session spec JSON"
        required: true
        default: "tests/fixtures/p7/paper_run_min_v0.json"
      run_id:
        description: "Deterministic run id"
        required: true
        default: "ci_smoke"
      note:
        description: "Free-form note"
        required: false
        default: "paper session telemetry summary"

permissions:
  contents: read

jobs:
  telemetry_summary:
    name: telemetry-summary (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    env:
      PEAK_TRADE_LIVE_ENABLED: "false"
      PT_DRY_RUN: "1"
      PT_EVIDENCE_INCLUDE_DECISION: "1"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run paper session (deterministic)
        run: |
          set -euo pipefail
          OUTDIR="out/ops/gh_paper_session_telemetry/${{ github.run_id }}_${{ github.run_attempt }}_py${{ matrix.python-version }}"
          mkdir -p "${OUTDIR}"
          python scripts/aiops/run_paper_trading_session.py \
            --spec "${{ github.event.inputs.spec }}" \
            --run-id "${{ github.event.inputs.run_id }}" \
            --outdir "${OUTDIR}/session_out" \
            --evidence 1
          test -f "${OUTDIR}/session_out/evidence_manifest.json"

          echo "spec=${{ github.event.inputs.spec }}" > "${OUTDIR}/run_params.txt"
          echo "run_id=${{ github.event.inputs.run_id }}" >> "${OUTDIR}/run_params.txt"
          echo "note=${{ github.event.inputs.note }}" >> "${OUTDIR}/run_params.txt"
          python -V > "${OUTDIR}/python_version.txt"

      - name: Generate telemetry summary (from evidence_manifest)
        run: |
          set -euo pipefail
          OUTDIR="out/ops/gh_paper_session_telemetry/${{ github.run_id }}_${{ github.run_attempt }}_py${{ matrix.python-version }}"
          MANIFEST="${OUTDIR}/session_out/evidence_manifest.json"
          python scripts/aiops/extract_policy_telemetry_summary.py \
            --manifest "${MANIFEST}" \
            --out "${OUTDIR}/telemetry_summary.json"
          test -f "${OUTDIR}/telemetry_summary.json"
          python - "${OUTDIR}/telemetry_summary.json" <<'PY'
          import json, sys
          p = sys.argv[1]
          d = json.load(open(p, "r", encoding="utf-8"))
          pol = d.get("policy") or {}
          assert isinstance(pol, dict) and pol, "policy must be non-empty"
          assert "action" in pol, "missing policy.action"
          PY

      - name: Audit manifest + SHA256
        run: |
          set -euo pipefail
          OUTDIR="out/ops/gh_paper_session_telemetry/${{ github.run_id }}_${{ github.run_attempt }}_py${{ matrix.python-version }}"
          python - "${OUTDIR}" <<'PY'
          import hashlib, json, pathlib, sys
          outdir = pathlib.Path(sys.argv[1])
          files = ["run_params.txt", "python_version.txt", "telemetry_summary.json", "session_out/evidence_manifest.json", "session_out/fills.json", "session_out/account.json"]
          manifest = {"items": []}
          for rel in files:
              p = outdir / rel
              assert p.exists(), f"missing {p}"
              h = hashlib.sha256(p.read_bytes()).hexdigest()
              manifest["items"].append({"path": rel, "sha256": h})
          (outdir / "manifest.json").write_text(json.dumps(manifest, indent=2, sort_keys=True), encoding="utf-8")
          lines = []
          for it in manifest["items"]:
              lines.append(f"{it['sha256']}  {it['path']}")
          (outdir / "SHA256SUMS.txt").write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY
          test -f "${OUTDIR}/manifest.json"
          test -f "${OUTDIR}/SHA256SUMS.txt"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gh-paper-session-telemetry-summary-py${{ matrix.python-version }}
          path: out/ops/gh_paper_session_telemetry/**
