name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  merge_group:
    branches: ["main", "master"]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"  # Monday 03:00 UTC

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Change Detection
  # ============================================================================
  # Detects whether code changes occurred (vs. docs-only changes).
  # This allows required test jobs to skip gracefully on docs-only PRs,
  # preventing "Pending" status checks that block merges.
  # ============================================================================
  changes:
    runs-on: ubuntu-latest
    outputs:
      code_changed: ${{ steps.detect.outputs.code_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: filter
        continue-on-error: true
        with:
          filters: |
            code:
              - 'src/**'
              - 'tests/**'
              - 'scripts/**'
              - 'config/**'
              - '.github/workflows/**'
              - 'requirements.txt'
              - 'pyproject.toml'
              - 'pytest.ini'
              - 'Makefile'

      - name: Compute code_changed (safe default)
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.filter.outcome }}" != "success" ]; then
            echo "paths-filter failed; defaulting code_changed=true (fail-open)"
            echo "code_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          val="${{ steps.filter.outputs.code }}"
          if [ -z "$val" ]; then val="false"; fi
          echo "code_changed=$val" >> "$GITHUB_OUTPUT"
          echo "code_changed=$val"

  # ============================================================================
  # CI Required Contexts Contract
  # ============================================================================
  # Validates that the CI workflow follows the required checks naming contract:
  # - Matrix jobs must have explicit names (e.g., tests (${{ matrix.python-version }}))
  # - No job-level if: conditions on required checks (would skip check creation)
  # This prevents PRs from being blocked by missing required check contexts.
  # See: docs/ops/ci_required_checks_matrix_naming_contract.md
  # ============================================================================
  ci-required-contexts-contract:
    name: ci-required-contexts-contract
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate CI Required Contexts Contract
        run: ./scripts/ops/check_required_ci_contexts_present.sh

  # ============================================================================
  # Tests (all Python versions)
  # ============================================================================
  # Always creates test jobs for all required Python versions (3.9, 3.10, 3.11).
  # On docs-only PRs, jobs skip gracefully (report SUCCESS/SKIPPED, not PENDING).
  # On code changes, runs full test suite.
  # ============================================================================
  tests:
    name: tests (${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: changes
    # IMPORTANT: No job-level if condition - matrix jobs must always be created
    # to satisfy branch protection rules (e.g., "tests (3.11)" check)

    strategy:
      fail-fast: false
      matrix:
        # Always create jobs for all required versions (to satisfy branch protection)
        python-version: ['3.9', '3.10', '3.11']

    steps:
      - name: Docs-only PR — skip tests
        if: ${{ github.event_name == 'pull_request' && needs.changes.outputs.code_changed != 'true' }}
        run: echo "Docs-only PR detected - skipping tests for Python ${{ matrix.python-version }}"

      - name: Checkout
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: "Stability Smoke Tests (Fast Gate)"
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        id: stability_smoke
        shell: bash
        run: |
          set -euo pipefail
          echo "Running fast stability smoke tests (<5s)..."
          pytest tests/test_stability_smoke.py tests/test_data_contracts.py tests/test_error_taxonomy.py tests/test_resilience.py -m smoke -v --tb=short

      - name: "Smoke: RL v0.1 Contract Test"
        if: ${{ (github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true') && runner.os == 'Linux' }}
        id: rl_v0_1_smoke
        shell: bash
        run: |
          set -euo pipefail
          pytest -q tests/test_rl_v0_1_smoke.py

      - name: Validate RL v0.1 Contract
        if: ${{ (github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true') && runner.os == 'Linux' }}
        id: rl_v0_1_contract
        shell: bash
        run: |
          bash scripts/validate_rl_v0_1.sh

      - name: Upload RL validation reports on failure
        if: ${{ failure() && runner.os == 'Linux' && (steps.rl_v0_1_smoke.outcome == 'failure' || steps.rl_v0_1_contract.outcome == 'failure') }}
        uses: actions/upload-artifact@v4
        with:
          name: rl-v0-1-validation-reports-py${{ matrix.python-version }}
          path: |
            reports/rl/**/*
            reports/rl_v0_1/**/*
            logs/rl/**/*
          if-no-files-found: ignore
          retention-days: 7

      - name: Run tests
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        run: |
          pytest tests/ -v --tb=short

      - name: Run tests with coverage
        if: ${{ (github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true') && matrix.python-version == '3.11' }}
        run: |
          pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing

      # TODO: Linting (optional, aktivieren wenn gewünscht)
      # - name: Run ruff
      #   run: |
      #     pip install ruff
      #     ruff check src/ tests/

  # ============================================================================
  # Strategy Smoke Tests (Phase 77)
  # ============================================================================
  # Runs the strategy smoke-check CLI and associated tests to ensure all
  # v1.1 strategies pass basic validation. This is a safety gate - if any
  # strategy fails the smoke test, the CI build fails.
  #
  # IMPORTANT: This job runs OFFLINE only - no live/testnet exchanges,
  # no API keys, no secrets. Uses only synthetic/backtest data.
  # ============================================================================
  strategy-smoke:
    name: strategy-smoke
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes, tests]  # Run after main tests pass
    # IMPORTANT: No job-level if condition - job must always be created
    # to satisfy branch protection rules (e.g., "strategy-smoke" check)

    steps:
      - name: Docs-only PR — skip strategy smoke tests
        if: ${{ github.event_name == 'pull_request' && needs.changes.outputs.code_changed != 'true' }}
        run: echo "Docs-only PR detected - skipping strategy smoke tests"

      - name: Checkout
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run strategy smoke pytest
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        run: |
          pytest tests/test_strategy_smoke_cli.py -v --tb=short

      - name: Create smoke results directory
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        run: |
          mkdir -p test_results/strategy_smoke

      - name: Run strategy smoke CLI
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        run: |
          python scripts/strategy_smoke_check.py \
            --output-json test_results/strategy_smoke/ci_smoke_latest.json \
            --output-md test_results/strategy_smoke/ci_smoke_latest.md

      - name: Upload smoke test artifacts
        if: ${{ always() && (github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true') }}
        uses: actions/upload-artifact@v4
        with:
          name: strategy-smoke-results
          path: test_results/strategy_smoke/
          retention-days: 30
