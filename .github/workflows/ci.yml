name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"  # Monday 03:00 UTC

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    name: Tests (Python ${{ matrix.python-version }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ${{ fromJSON((github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || (github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'master'))) && '["3.10","3.11","3.12"]' || '["3.11"]') }}
        include:
          # Add macOS runner for Apple Silicon testing (on main branch or manual trigger)
          - os: macos-latest
            python-version: "3.11"
            macos-test: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Cache pytest
        uses: actions/cache@v4
        with:
          path: .pytest_cache
          key: ${{ runner.os }}-pytest-${{ matrix.python-version }}-${{ hashFiles('tests/**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-pytest-${{ matrix.python-version }}-
            ${{ runner.os }}-pytest-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: "Smoke: RL v0.1 Contract Test"
        id: rl_v0_1_smoke
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          pytest -q tests/test_rl_v0_1_smoke.py

      - name: Validate RL v0.1 Contract
        id: rl_v0_1_contract
        if: runner.os == 'Linux'
        shell: bash
        run: |
          bash scripts/validate_rl_v0_1.sh

      - name: Upload RL validation reports on failure
        if: ${{ failure() && runner.os == 'Linux' && (steps.rl_v0_1_smoke.outcome == 'failure' || steps.rl_v0_1_contract.outcome == 'failure') }}
        uses: actions/upload-artifact@v4
        with:
          name: rl-v0-1-validation-reports-py${{ matrix.python-version }}
          path: |
            reports/rl/**/*
            reports/rl_v0_1/**/*
            logs/rl/**/*
          if-no-files-found: ignore
          retention-days: 7

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short

      - name: Run tests with coverage
        if: matrix.python-version == '3.11' && runner.os == 'Linux'
        run: |
          pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload test reports
        if: always() && runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            coverage.xml
            .pytest_cache/
          if-no-files-found: ignore
          retention-days: 30

      # TODO: Linting (optional, aktivieren wenn gew√ºnscht)
      # - name: Run ruff
      #   run: |
      #     pip install ruff
      #     ruff check src/ tests/

  # ============================================================================
  # Strategy Smoke Tests (Phase 77)
  # ============================================================================
  # Runs the strategy smoke-check CLI and associated tests to ensure all
  # v1.1 strategies pass basic validation. This is a safety gate - if any
  # strategy fails the smoke test, the CI build fails.
  #
  # IMPORTANT: This job runs OFFLINE only - no live/testnet exchanges,
  # no API keys, no secrets. Uses only synthetic/backtest data.
  # ============================================================================
  strategy-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: tests  # Run after main tests pass

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run strategy smoke pytest
        run: |
          pytest tests/test_strategy_smoke_cli.py -v --tb=short

      - name: Create smoke results directory
        run: |
          mkdir -p test_results/strategy_smoke

      - name: Run strategy smoke CLI
        run: |
          python scripts/strategy_smoke_check.py \
            --output-json test_results/strategy_smoke/ci_smoke_latest.json \
            --output-md test_results/strategy_smoke/ci_smoke_latest.md

      - name: Upload smoke test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strategy-smoke-results
          path: test_results/strategy_smoke/
          retention-days: 30
