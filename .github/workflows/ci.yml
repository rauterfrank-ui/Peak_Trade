
# ci smoke workflow-only 20260207-0217Z
# ci smoke workflow-only 20260207-0135Z
name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: ["main", "master"]
  merge_group:
    branches: ["main", "master"]
  workflow_dispatch:
    inputs:
      force_matrix:
        description: 'Force full Python matrix (run_matrix=true) regardless of changed paths'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: "0 3 * * 1"  # Monday 03:00 UTC

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Change Detection (pragmatic flow)
  # ============================================================================
  # Outputs: code_changed (legacy), run_matrix, run_fast_lane, docs_only, workflow_only.
  # - run_fast_lane: always true (Fast-Lane always runs).
  # - run_matrix: true when code paths changed (or workflow_dispatch force_matrix=true).
  # - run_fast: always true. run_fast_lane: alias.
  # - docs_only: true when ONLY docs/out/*.md changed.
  # - workflow_only: true when ONLY .github/workflows changed.
  # Code paths: src/**, tests/**, scripts/**, config/**, pyproject.toml, uv.lock, requirements*.txt, pytest.ini, Makefile.
  # ============================================================================
  changes:
    runs-on: ubuntu-latest
    outputs:
      code_changed: ${{ steps.filter.outputs.code }}
      run_matrix: ${{ steps.set_outputs.outputs.run_matrix }}
      run_fast: ${{ steps.set_outputs.outputs.run_fast }}
      run_fast_lane: ${{ steps.set_outputs.outputs.run_fast }}
      docs_only: ${{ steps.set_outputs.outputs.docs_only }}
      workflow_only: ${{ steps.set_outputs.outputs.workflow_only }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'src/**'
              - 'tests/**'
              - 'scripts/**'
              - 'config/**'
              - 'requirements.txt'
              - 'requirements*.txt'
              - 'pyproject.toml'
              - 'uv.lock'
              - 'pytest.ini'
              - 'Makefile'
            docs:
              - 'docs/**'
              - 'out/**'
              - '**/*.md'
            workflow:
              - '.github/workflows/**'

      - name: Set pragmatic flow outputs
        id: set_outputs
        run: |
          FORCE_MATRIX="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_matrix == 'true' }}"
          if [ "$FORCE_MATRIX" = "true" ]; then
            echo "run_matrix=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_matrix=${{ steps.filter.outputs.code }}" >> "$GITHUB_OUTPUT"
          fi
          echo "run_fast=true" >> "$GITHUB_OUTPUT"
          CODE="${{ steps.filter.outputs.code }}"
          DOCS="${{ steps.filter.outputs.docs }}"
          WF="${{ steps.filter.outputs.workflow }}"
          if [ "$DOCS" = "true" ] && [ "$CODE" != "true" ] && [ "$WF" != "true" ]; then
            echo "docs_only=true" >> "$GITHUB_OUTPUT"
          else
            echo "docs_only=false" >> "$GITHUB_OUTPUT"
          fi
          if [ "$WF" = "true" ] && [ "$CODE" != "true" ] && [ "$DOCS" != "true" ]; then
            echo "workflow_only=true" >> "$GITHUB_OUTPUT"
          else
            echo "workflow_only=false" >> "$GITHUB_OUTPUT"
          fi

  # ============================================================================
  # CI Required Contexts Contract
  # ============================================================================
  # Validates that the CI workflow follows the required checks naming contract:
  # - Matrix jobs must have explicit names (e.g., tests (${{ matrix.python-version }}))
  # - No job-level if: conditions on required checks (would skip check creation)
  # This prevents PRs from being blocked by missing required check contexts.
  # See: docs/ops/ci_required_checks_matrix_naming_contract.md
  # Ops: mergeable UNKNOWN quickflow siehe docs/ops/runbooks/github_rulesets_pr_reviews_policy.md
  # ============================================================================
  ci-required-contexts-contract:
    name: ci-required-contexts-contract
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate CI Required Contexts Contract
        run: ./scripts/ops/check_required_ci_contexts_present.sh

  # ============================================================================
  # Evidence Validator (P5B required check)
  # ============================================================================
  # Generates a deterministic pack from fixtures and validates via
  # scripts/aiops/validate_evidence_pack.py. Always runs (no job-level if)
  # to satisfy required check contract.
  # ============================================================================
  evidence-validator:
    name: Evidence Validator
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: changes
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate and validate Evidence Pack (P5B)
        run: scripts/ci/evidence_pack_validation_smoke.sh

  # ============================================================================
  # Fast-Lane (always runs; minimal smoke for docs/workflow-only PRs)
  # ============================================================================
  fast-lane:
    name: Fast-Lane
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: changes
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Stability smoke (fast gate)
        run: |
          pytest tests/test_stability_smoke.py tests/test_data_contracts.py tests/test_error_taxonomy.py tests/test_resilience.py -m smoke -v --tb=short

  # ============================================================================
  # Tests (all Python versions)
  # ============================================================================
  # Always creates test jobs for all required Python versions (3.9, 3.10, 3.11).
  # On docs-only PRs, jobs skip gracefully (report SUCCESS/SKIPPED, not PENDING).
  # On code changes, runs full test suite.
  # ============================================================================
  tests:
    name: tests (${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: changes
    # IMPORTANT: No job-level if condition - matrix jobs must always be created
    # to satisfy branch protection rules (e.g., "tests (3.11)" check)

    strategy:
      fail-fast: false
      matrix:
        # Always create jobs for all required versions (to satisfy branch protection)
        python-version: ['3.9', '3.10', '3.11']

    steps:
      - name: Docs-only PR — skip tests
        if: ${{ github.event_name == 'pull_request' && needs.changes.outputs.code_changed != 'true' }}
        run: echo "Docs-only PR detected - skipping tests for Python ${{ matrix.python-version }}"

      - name: Checkout
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: "Stability Smoke Tests (Fast Gate)"
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        id: stability_smoke
        shell: bash
        run: |
          set -euo pipefail
          echo "Running fast stability smoke tests (<5s)..."
          pytest tests/test_stability_smoke.py tests/test_data_contracts.py tests/test_error_taxonomy.py tests/test_resilience.py -m smoke -v --tb=short

      - name: "Smoke: RL v0.1 Contract Test"
        if: ${{ (github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true') && runner.os == 'Linux' }}
        id: rl_v0_1_smoke
        shell: bash
        run: |
          set -euo pipefail
          pytest -q tests/test_rl_v0_1_smoke.py

      - name: Validate RL v0.1 Contract
        if: ${{ (github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true') && runner.os == 'Linux' }}
        id: rl_v0_1_contract
        shell: bash
        run: |
          bash scripts/validate_rl_v0_1.sh

      - name: Upload RL validation reports on failure
        if: ${{ failure() && runner.os == 'Linux' && (steps.rl_v0_1_smoke.outcome == 'failure' || steps.rl_v0_1_contract.outcome == 'failure') }}
        uses: actions/upload-artifact@v4
        with:
          name: rl-v0-1-validation-reports-py${{ matrix.python-version }}
          path: |
            reports/rl/**/*
            reports/rl_v0_1/**/*
            logs/rl/**/*
          if-no-files-found: ignore
          retention-days: 7

      - name: Run tests
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        run: |
          pytest tests/ -v --tb=short -m "not network and not external_tools"

      - name: Run tests with coverage
        if: ${{ (github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true') && matrix.python-version == '3.11' }}
        run: |
          pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing -m "not network and not external_tools"

      # TODO: Linting (optional, aktivieren wenn gewünscht)
      # - name: Run ruff
      #   run: |
      #     pip install ruff
      #     ruff check src/ tests/

  # ============================================================================
  # Strategy Smoke Tests (Phase 77)
  # ============================================================================
  # Runs the strategy smoke-check CLI and associated tests to ensure all
  # v1.1 strategies pass basic validation. This is a safety gate - if any
  # strategy fails the smoke test, the CI build fails.
  #
  # IMPORTANT: This job runs OFFLINE only - no live/testnet exchanges,
  # no API keys, no secrets. Uses only synthetic/backtest data.
  # ============================================================================
  strategy-smoke:
    name: strategy-smoke
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes, tests]  # Run after main tests pass
    # IMPORTANT: No job-level if condition - job must always be created
    # to satisfy branch protection rules (e.g., "strategy-smoke" check)

    steps:
      - name: Docs-only PR — skip strategy smoke tests
        if: ${{ github.event_name == 'pull_request' && needs.changes.outputs.code_changed != 'true' }}
        run: echo "Docs-only PR detected - skipping strategy smoke tests"

      - name: Checkout
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run strategy smoke pytest
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        run: |
          pytest tests/test_strategy_smoke_cli.py -v --tb=short

      - name: Create smoke results directory
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        run: |
          mkdir -p test_results/strategy_smoke

      - name: Run strategy smoke CLI
        if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' }}
        run: |
          python scripts/strategy_smoke_check.py \
            --output-json test_results/strategy_smoke/ci_smoke_latest.json \
            --output-md test_results/strategy_smoke/ci_smoke_latest.md

      - name: Upload smoke test artifacts
        if: ${{ always() && (github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true') }}
        uses: actions/upload-artifact@v4
        with:
          name: strategy-smoke-results
          path: test_results/strategy_smoke/
          retention-days: 30

  # ============================================================================
  # PR Gate (single required check for branch protection)
  # ============================================================================
  # When run_matrix=false: Fast-Lane + (tests/strategy-smoke skip) → SUCCESS.
  # When run_matrix=true: Fast-Lane + tests (3.9/3.10/3.11) + strategy-smoke → SUCCESS.
  # Branch protection: require only "PR Gate".
  # ============================================================================
  pr-gate:
    name: PR Gate
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [changes, fast-lane, tests, strategy-smoke]
    if: always() && !cancelled() && needs.changes.result == 'success'
    steps:
      - name: Require all gates passed
        run: |
          [[ "${{ needs.fast-lane.result }}" == "success" ]] || { echo "Fast-Lane failed"; exit 1; }
          [[ "${{ needs.tests.result }}" == "success" ]] || { echo "tests failed"; exit 1; }
          [[ "${{ needs.strategy-smoke.result }}" == "success" ]] || { echo "strategy-smoke failed"; exit 1; }
          echo "PR Gate: all gates passed (run_matrix=${{ needs.changes.outputs.run_matrix }}, docs_only=${{ needs.changes.outputs.docs_only }}, workflow_only=${{ needs.changes.outputs.workflow_only }})"
