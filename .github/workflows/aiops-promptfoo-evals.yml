name: AI-Ops Promptfoo Evals

on:
  pull_request:
    paths:
      - '.cursor/**'
      - 'docs/ai/**'
      - 'evals/aiops/**'
      - 'scripts/aiops/**'
      - '.github/workflows/**'
  push:
    branches: [main]
    paths:
      - '.cursor/**'
      - 'docs/ai/**'
      - 'evals/aiops/**'
      - 'scripts/aiops/**'
      - '.github/workflows/aiops-promptfoo-evals.yml'
  workflow_dispatch:

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      run_evals: ${{ steps.filter.outputs.run_evals }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for eval-relevant changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            run_evals:
              - '.cursor/**'
              - 'docs/ai/**'
              - 'evals/aiops/**'
              - 'scripts/aiops/**'
              - '.github/workflows/aiops-promptfoo-evals.yml'

  promptfoo-eval:
    name: Run Promptfoo Evals
    needs: changes
    if: needs.changes.outputs.run_evals == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Prepare AIOps artifacts dir
        run: mkdir -p .artifacts/aiops

      - name: Run Promptfoo Eval
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          bash scripts/aiops/run_promptfoo_eval.sh

      - name: Ensure eval artifacts (fallback if empty)
        run: |
          mkdir -p .artifacts/aiops
          if [ "$(find .artifacts/aiops -type f 2>/dev/null | wc -l | tr -d ' ')" = "0" ]; then
            printf '%s\n' '{"status":"ran","note":"no outputs produced"}' > .artifacts/aiops/eval_empty.json
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: promptfoo-eval-logs
          path: .artifacts/aiops/
          retention-days: 7

  noop:
    name: Skip Evals (No Relevant Changes)
    needs: changes
    if: needs.changes.outputs.run_evals != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare AIOps artifacts dir
        run: mkdir -p .artifacts/aiops

      - name: Write skip marker
        run: |
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo "{\"status\":\"skipped\",\"reason\":\"run_evals=false or missing OPENAI_API_KEY\",\"ts_utc\":\"$TS\"}" > .artifacts/aiops/skip.json

      - name: Log skip reason
        run: |
          echo "No eval-relevant changes detected. Skipping promptfoo evals."
          echo "This job succeeds to avoid false negatives in CI status."

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: promptfoo-eval-logs
          path: .artifacts/aiops/
          retention-days: 7
