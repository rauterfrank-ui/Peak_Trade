name: AIOps - Trend Ledger from Seed

env:
  ARTIFACT_NAME: trend-seed-artifact

# Phase 5B: Generate canonical Trend Ledger from Phase 5A Trend Seed
# Trigger: workflow_run on Phase 5A workflow completion (success only, main branch only)
# Outputs: trend_ledger.json (canonical), trend_ledger.md (summary), manifest.json

on:
  workflow_run:
    workflows: ["AIOps - Trend Seed from Normalized Report"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  generate-trend-ledger:
    name: Generate Trend Ledger
    runs-on: ubuntu-latest

    # Only run if Phase 5A workflow succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Assert upstream artifact exists
        if: github.event_name == 'workflow_run'
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          ARTIFACT_NAME: ${{ env.ARTIFACT_NAME }}
        run: |
          set -euo pipefail
          echo "source_workflow=${{ github.event.workflow_run.name }}"
          echo "source_run_id=${{ github.event.workflow_run.id }}"
          echo "commit_sha=${{ github.event.workflow_run.head_sha }}"
          curl -sSf -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts" \
            > artifacts.json
          echo "Artifacts:"
          python3 - <<'PY2'
          import json
          d = json.load(open("artifacts.json", encoding="utf-8"))
          arts = d.get("artifacts") or []
          for a in arts:
              print("-", a.get("name"), "expired=", a.get("expired"), "size=", a.get("size_in_bytes"))
          PY2
          python3 - <<'PY3'
          import json, sys, os
          d = json.load(open("artifacts.json", encoding="utf-8"))
          arts = [a.get("name") for a in (d.get("artifacts") or [])]
          want = os.environ.get("ARTIFACT_NAME", "trend-seed-artifact")
          if want not in arts:
              sys.exit(f"ERROR: expected artifact '{want}' not found. Present={arts}")
          print("OK: artifact present:", want)
          PY3

      - name: Download Phase 5A trend seed artifact
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: aiops-trend-seed-from-normalized-report.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: ${{ env.ARTIFACT_NAME }}
          path: .tmp/phase5a_artifacts

      - name: Verify artifact contents
        if: github.event_name == 'workflow_run'
        run: |
          echo "=== Verifying Phase 5A artifact contents ==="
          ls -lh .tmp/phase5a_artifacts/

          if [ ! -f ".tmp/phase5a_artifacts/trend_seed.normalized_report.json" ]; then
            echo "âŒ ERROR: trend_seed.normalized_report.json not found in artifact"
            exit 1
          fi

          echo "âœ… Artifact verified"

      - name: Generate Trend Ledger
        run: |
          echo "=== Generating Trend Ledger ==="

          # Run Phase 5B consumer
          uv run python scripts/aiops/generate_trend_ledger_from_seed.py \
            --input ".tmp/phase5a_artifacts/trend_seed.normalized_report.json" \
            --output-json ".tmp/trend_ledger/trend_ledger.json" \
            --output-markdown ".tmp/trend_ledger/trend_ledger.md" \
            --run-manifest ".tmp/trend_ledger/manifest.json"

      - name: Verify Trend Ledger outputs
        run: |
          echo "=== Verifying Trend Ledger outputs ==="
          ls -lh .tmp/trend_ledger/

          # Check required files exist
          if [ ! -f ".tmp/trend_ledger/trend_ledger.json" ]; then
            echo "âŒ ERROR: trend_ledger.json not found"
            exit 1
          fi

          if [ ! -f ".tmp/trend_ledger/trend_ledger.md" ]; then
            echo "âŒ ERROR: trend_ledger.md not found"
            exit 1
          fi

          if [ ! -f ".tmp/trend_ledger/manifest.json" ]; then
            echo "âŒ ERROR: manifest.json not found"
            exit 1
          fi

          # Validate JSON structure
          echo ""
          echo "=== Trend Ledger JSON preview ==="
          jq '.schema_version, .source_run.run_id, .counters' \
            .tmp/trend_ledger/trend_ledger.json

          echo ""
          echo "âœ… Trend Ledger outputs verified"

      - name: Upload Trend Ledger artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trend-ledger-${{ github.event.workflow_run.id }}
          path: |
            .tmp/trend_ledger/trend_ledger.json
            .tmp/trend_ledger/trend_ledger.md
            .tmp/trend_ledger/manifest.json
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Trend Ledger Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Workflow** | ${{ github.event.workflow_run.name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Run ID** | ${{ github.event.workflow_run.id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit SHA** | ${{ github.event.workflow_run.head_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.event.workflow_run.head_branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact** | trend-ledger-${{ github.event.workflow_run.id }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f ".tmp/trend_ledger/trend_ledger.json" ]; then
            echo "### ðŸ“‹ Trend Ledger Preview" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            jq '.' .tmp/trend_ledger/trend_ledger.json | head -30 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f ".tmp/trend_ledger/trend_ledger.md" ]; then
            echo "### ðŸ“„ Markdown Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat .tmp/trend_ledger/trend_ledger.md >> $GITHUB_STEP_SUMMARY
          fi
