name: AIOps - Trend Ledger from Seed

env:
  ARTIFACT_NAME: trend-seed-artifact

# Phase 5B: Generate canonical Trend Ledger from Phase 5A Trend Seed
# Trigger: workflow_run on Phase 5A workflow completion (success only, main branch only)
# Outputs: trend_ledger.json (canonical), trend_ledger.md (summary), manifest.json

on:
  workflow_run:
    workflows: ["AIOps - Trend Seed from Normalized Report"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      run_id:
        description: "Source workflow_run id to fetch artifacts from (optional; omit to skip)"
        required: false
        type: string

permissions:
  contents: read
  actions: read

jobs:
  generate-trend-ledger:
    name: Generate Trend Ledger
    runs-on: ubuntu-latest

    # Only run if Phase 5A workflow succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Skip notice (workflow_dispatch without run_id)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_id == ''
        run: |
          echo "::notice::Skipped: workflow_dispatch without run_id. Provide run_id to fetch artifacts from a specific Trend Seed run."
          echo "Job passes (no-op)."

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Assert upstream artifact exists
        if: github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_id != '')
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          ARTIFACT_NAME: ${{ env.ARTIFACT_NAME }}
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            RUN_ID="${{ github.event.workflow_run.id }}"
            echo "source_workflow=${{ github.event.workflow_run.name }}"
            echo "commit_sha=${{ github.event.workflow_run.head_sha }}"
          else
            RUN_ID="${{ github.event.inputs.run_id }}"
            echo "source_workflow=manual (workflow_dispatch)"
            echo "commit_sha=n/a"
          fi
          echo "source_run_id=${RUN_ID}"
          export RUN_ID
          echo "RUN_ID=${RUN_ID}" >> "$GITHUB_ENV"
          curl -sSf -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/actions/runs/${RUN_ID}/artifacts" \
            > artifacts.json
          echo "Artifacts:"
          python3 - <<'PY2'
          import json
          d = json.load(open("artifacts.json", encoding="utf-8"))
          arts = d.get("artifacts") or []
          for a in arts:
              print("-", a.get("name"), "expired=", a.get("expired"), "size=", a.get("size_in_bytes"))
          PY2
          # Try fixed first, then legacy trend-seed-<run_id>, then any trend-seed-*
          python3 - <<PY3
          import json, sys, os
          d = json.load(open("artifacts.json", encoding="utf-8"))
          arts = [a.get("name") for a in (d.get("artifacts") or [])]
          fixed = os.environ.get("ARTIFACT_NAME", "trend-seed-artifact")
          legacy = f"trend-seed-{os.environ.get('RUN_ID', '')}"
          trend_seeds = [a for a in arts if a and a.startswith("trend-seed-")]
          if fixed in arts:
              effective = fixed
              print(f"OK: using fixed artifact: {effective}")
          elif legacy in arts:
              effective = legacy
              print(f"OK: using legacy artifact: {effective}")
          elif trend_seeds:
              effective = trend_seeds[0]
              print(f"OK: using trend-seed-* artifact: {effective}")
          else:
              sys.exit(f"ERROR: expected artifact '{fixed}' or '{legacy}' or trend-seed-* not found. Present={arts}")
          with open(os.environ.get("GITHUB_ENV", "/dev/null"), "a") as f:
              f.write(f"ARTIFACT_NAME_EFFECTIVE={effective}\n")
          PY3

      - name: Download Phase 5A trend seed artifact
        if: github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_id != '')
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: aiops-trend-seed-from-normalized-report.yml
          run_id: ${{ github.event.workflow_run.id || github.event.inputs.run_id }}
          name: ${{ env.ARTIFACT_NAME_EFFECTIVE || env.ARTIFACT_NAME }}
          path: .tmp/phase5a_artifacts

      - name: Verify artifact contents
        if: github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_id != '')
        run: |
          echo "=== Verifying Phase 5A artifact contents ==="
          ls -lh .tmp/phase5a_artifacts/

          if [ ! -f ".tmp/phase5a_artifacts/trend_seed.normalized_report.json" ]; then
            echo "âŒ ERROR: trend_seed.normalized_report.json not found in artifact"
            exit 1
          fi

          echo "âœ… Artifact verified"

      - name: Generate Trend Ledger
        if: github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_id != '')
        run: |
          echo "=== Generating Trend Ledger ==="

          # Run Phase 5B consumer
          uv run python scripts/aiops/generate_trend_ledger_from_seed.py \
            --input ".tmp/phase5a_artifacts/trend_seed.normalized_report.json" \
            --output-json ".tmp/trend_ledger/trend_ledger.json" \
            --output-markdown ".tmp/trend_ledger/trend_ledger.md" \
            --run-manifest ".tmp/trend_ledger/manifest.json"

      - name: Verify Trend Ledger outputs
        if: github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_id != '')
        run: |
          echo "=== Verifying Trend Ledger outputs ==="
          ls -lh .tmp/trend_ledger/

          # Check required files exist
          if [ ! -f ".tmp/trend_ledger/trend_ledger.json" ]; then
            echo "âŒ ERROR: trend_ledger.json not found"
            exit 1
          fi

          if [ ! -f ".tmp/trend_ledger/trend_ledger.md" ]; then
            echo "âŒ ERROR: trend_ledger.md not found"
            exit 1
          fi

          if [ ! -f ".tmp/trend_ledger/manifest.json" ]; then
            echo "âŒ ERROR: manifest.json not found"
            exit 1
          fi

          # Validate JSON structure
          echo ""
          echo "=== Trend Ledger JSON preview ==="
          jq '.schema_version, .source_run.run_id, .counters' \
            .tmp/trend_ledger/trend_ledger.json

          echo ""
          echo "âœ… Trend Ledger outputs verified"

      - name: Upload Trend Ledger artifacts
        if: github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_id != '')
        uses: actions/upload-artifact@v4
        with:
          name: trend-ledger-${{ github.event.workflow_run.id || github.run_id }}
          path: |
            .tmp/trend_ledger/trend_ledger.json
            .tmp/trend_ledger/trend_ledger.md
            .tmp/trend_ledger/manifest.json
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Trend Ledger Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Workflow** | ${{ github.event.workflow_run.name || 'manual (workflow_dispatch)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Run ID** | ${{ github.event.workflow_run.id || github.event.inputs.run_id || github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit SHA** | ${{ github.event.workflow_run.head_sha || github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.event.workflow_run.head_branch || github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact** | trend-ledger-${{ github.event.workflow_run.id || github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f ".tmp/trend_ledger/trend_ledger.json" ]; then
            echo "### ðŸ“‹ Trend Ledger Preview" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            jq '.' .tmp/trend_ledger/trend_ledger.json | head -30 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f ".tmp/trend_ledger/trend_ledger.md" ]; then
            echo "### ðŸ“„ Markdown Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat .tmp/trend_ledger/trend_ledger.md >> $GITHUB_STEP_SUMMARY
          fi
