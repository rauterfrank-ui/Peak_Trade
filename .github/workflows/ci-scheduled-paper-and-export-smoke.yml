name: CI / Scheduled Paper + Export Smoke

"on":
  workflow_dispatch:
  schedule:
    - cron: "17 * * * *"

permissions:
  actions: write
  contents: read

concurrency:
  group: scheduled-paper-export-smoke
  cancel-in-progress: true

jobs:
  paper_tests_audit_evidence:
    if: vars.PT_SCHEDULED_PAPER_TESTS_ENABLED == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Guardrails (vars/secrets)
        shell: bash
        env:
          PT_SCHEDULED_PAPER_TESTS_ENABLED: ${{ vars.PT_SCHEDULED_PAPER_TESTS_ENABLED }}
          PT_SCHEDULED_EXPORT_VERIFY_ENABLED: ${{ vars.PT_SCHEDULED_EXPORT_VERIFY_ENABLED }}
          PT_RCLONE_CONF_B64: ${{ secrets.PT_RCLONE_CONF_B64 }}
          PT_EXPORT_REMOTE: ${{ secrets.PT_EXPORT_REMOTE }}
          PT_EXPORT_PREFIX: ${{ secrets.PT_EXPORT_PREFIX }}
        run: |
          bash scripts/ci/scheduled_guardrails.sh
      - name: Trigger paper-tests-audit-evidence
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh workflow run "paper-tests-audit-evidence" -f scope=execution -f note="scheduled smoke (hourly)"

  export_pack_verify:
    if: vars.PT_SCHEDULED_EXPORT_VERIFY_ENABLED == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Guardrails (vars/secrets)
        shell: bash
        env:
          PT_SCHEDULED_PAPER_TESTS_ENABLED: ${{ vars.PT_SCHEDULED_PAPER_TESTS_ENABLED }}
          PT_SCHEDULED_EXPORT_VERIFY_ENABLED: ${{ vars.PT_SCHEDULED_EXPORT_VERIFY_ENABLED }}
          PT_RCLONE_CONF_B64: ${{ secrets.PT_RCLONE_CONF_B64 }}
          PT_EXPORT_REMOTE: ${{ secrets.PT_EXPORT_REMOTE }}
          PT_EXPORT_PREFIX: ${{ secrets.PT_EXPORT_PREFIX }}
        run: |
          bash scripts/ci/scheduled_guardrails.sh
      - name: Trigger CI / Export Pack Download + Verify
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh workflow run "CI / Export Pack Download + Verify" -f export_id=""
