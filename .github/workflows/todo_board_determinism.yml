name: TODO Board determinism

on:
  pull_request:
    paths:
      - "scripts/build_todo_board_html.py"
      - "docs/00_overview/**"
      - "docs/**TODO**"
      - "docs/**todo**"
  push:
    branches: [ "main" ]
    paths:
      - "scripts/build_todo_board_html.py"
      - "docs/00_overview/**"
      - "docs/**TODO**"
      - "docs/**todo**"
  workflow_dispatch: {}

jobs:
  determinism:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TZ: UTC
      LC_ALL: C
      LANG: C
      PYTHONHASHSEED: "0"

    steps:
      - name: Checkout (full history required for git log)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps (if requirements.txt exists)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Determinism + path-independence check
        shell: bash
        run: |
          set -euo pipefail

          OUT_HTML="docs/00_overview/PEAK_TRADE_TODO_BOARD.html"
          OUT_README="docs/00_overview/README_TODO_BOARD.md"

          snap_copy () {
            local dest="$1"
            mkdir -p "$dest"
            for f in "$OUT_HTML" "$OUT_README"; do
              if [ -f "$f" ]; then
                mkdir -p "$dest/$(dirname "$f")"
                cp -a "$f" "$dest/$f"
              fi
            done
          }

          snap_diff () {
            local a="$1"
            local b="$2"
            for f in "$OUT_HTML" "$OUT_README"; do
              if [ -f "$a/$f" ] && [ -f "$b/$f" ]; then
                diff -u "$a/$f" "$b/$f"
              elif [ -f "$a/$f" ] || [ -f "$b/$f" ]; then
                echo "❌ Output file presence mismatch for: $f"
                echo "   $a/$f exists? $(test -f "$a/$f" && echo yes || echo no)"
                echo "   $b/$f exists? $(test -f "$b/$f" && echo yes || echo no)"
                exit 1
              fi
            done
          }

          echo "== Run #1 (workspace) =="
          python3 scripts/build_todo_board_html.py
          snap_copy /tmp/pt_out_1

          git reset --hard
          git clean -fd

          echo "== Run #2 (workspace) =="
          python3 scripts/build_todo_board_html.py
          snap_copy /tmp/pt_out_2

          echo "== Compare Run #1 vs Run #2 (same path) =="
          snap_diff /tmp/pt_out_1 /tmp/pt_out_2

          echo "== Path-independence (different absolute path via worktree) =="
          ALT_DIR="/tmp/pt_alt_worktree"
          rm -rf "$ALT_DIR" || true
          git worktree add "$ALT_DIR" HEAD

          (cd "$ALT_DIR" && python3 scripts/build_todo_board_html.py)

          mkdir -p /tmp/pt_out_alt/docs/00_overview
          if [ -f "$ALT_DIR/$OUT_HTML" ]; then
            mkdir -p "/tmp/pt_out_alt/$(dirname "$OUT_HTML")"
            cp -a "$ALT_DIR/$OUT_HTML" "/tmp/pt_out_alt/$OUT_HTML"
          fi
          if [ -f "$ALT_DIR/$OUT_README" ]; then
            mkdir -p "/tmp/pt_out_alt/$(dirname "$OUT_README")"
            cp -a "$ALT_DIR/$OUT_README" "/tmp/pt_out_alt/$OUT_README"
          fi

          git worktree remove --force "$ALT_DIR"

          echo "== Compare workspace vs alt-worktree (different path) =="
          snap_diff /tmp/pt_out_2 /tmp/pt_out_alt

          echo "✅ Deterministic AND path-independent."
