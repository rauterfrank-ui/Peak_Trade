name: Docs Integrity Snapshot

# OPTIONAL workflow (NOT required for branch protection)
# Provides informational reports on docs link graph and orphaned pages

on:
  pull_request:
    paths:
      - 'docs/**'
      - 'scripts/ops/docs_graph_snapshot.py'
      - 'scripts/ops/_docs_graph.py'
      - '.github/workflows/**'

permissions:
  contents: read

jobs:
  docs-integrity-snapshot:
    name: Generate Docs Integrity Snapshot
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate docs graph snapshot
        run: |
          python scripts/ops/docs_graph_snapshot.py \
            --out docs_graph.snapshot.json

      - name: Display snapshot summary
        run: |
          echo "## Docs Integrity Snapshot Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          python -c "import json; data=json.load(open('docs_graph.snapshot.json')); print(json.dumps(data['stats'], indent=2))" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload docs graph snapshot
        uses: actions/upload-artifact@v4
        with:
          name: docs-graph-snapshot
          path: docs_graph.snapshot.json
          retention-days: 30

      - name: Check for critical issues
        run: |
          # Extract stats from JSON
          BROKEN_TARGETS=$(python -c "import json; data=json.load(open('docs_graph.snapshot.json')); print(data['stats']['broken_targets'])")
          BROKEN_ANCHORS=$(python -c "import json; data=json.load(open('docs_graph.snapshot.json')); print(data['stats']['broken_anchors'])")
          TOTAL_BROKEN=$((BROKEN_TARGETS + BROKEN_ANCHORS))

          echo "üîç Broken links found: $TOTAL_BROKEN (targets: $BROKEN_TARGETS, anchors: $BROKEN_ANCHORS)"

          # This is informational only - does NOT fail the workflow
          if [ "$TOTAL_BROKEN" -gt 0 ]; then
            echo "‚ö†Ô∏è Warning: Found $TOTAL_BROKEN broken link(s). Review the snapshot report."
            echo "Note: This is informational only and does not block PR merge."
          else
            echo "‚úÖ No broken links found."
          fi
