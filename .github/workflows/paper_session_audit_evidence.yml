name: paper-session-audit-evidence

on:
  workflow_dispatch:
    inputs:
      spec:
        description: "Paper run spec JSON (repo path)"
        required: true
        default: "tests/fixtures/p7/paper_run_min_v0.json"
      run_id:
        description: "Deterministic run id"
        required: true
        default: "ci_smoke"
      note:
        description: "Optional operator note (audit metadata)"
        required: false
        default: ""

permissions:
  contents: read
  actions: write

jobs:
  paper_session:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    env:
      # Hard safety: no live/testnet
      PEAK_TRADE_TESTNET_ONLY: "false"
      PEAK_TRADE_LIVE_ENABLED: "false"
      PEAK_TRADE_LIVE_ARMED: "false"
      PT_DRY_RUN: "1"
      PT_EVIDENCE_INCLUDE_DECISION: "1"

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "${{ matrix.python-version }}"

      - name: Install
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run Paper Session (offline) + Audit Evidence
        run: |
          set -euo pipefail
          # YAML-safe: define EVI_DIR inside run (avoid step.env parsing edge-cases)
          EVI_DIR="out/ops/gh_paper_session_audit/${{ github.run_id }}_${{ github.run_attempt }}_py${{ matrix.python-version }}"
          export EVI_DIR

          mkdir -p "${EVI_DIR}"

          # --- audit metadata ---
          {
            echo "ts_utc=$(date -u +%Y%m%dT%H%M%SZ)"
            echo "workflow=${{ github.workflow }}"
            echo "run_id=${{ github.run_id }}"
            echo "run_attempt=${{ github.run_attempt }}"
            echo "job=${{ github.job }}"
            echo "ref=${{ github.ref }}"
            echo "sha=${{ github.sha }}"
            echo "actor=${{ github.actor }}"
            echo "spec=${{ github.event.inputs.spec }}"
            echo "note=${{ github.event.inputs.note }}"
            echo "run_id=${{ github.event.inputs.run_id }}"
            echo "safety.PEAK_TRADE_LIVE_ENABLED=${PEAK_TRADE_LIVE_ENABLED}"
            echo "safety.PEAK_TRADE_LIVE_ARMED=${PEAK_TRADE_LIVE_ARMED}"
            echo "safety.PT_DRY_RUN=${PT_DRY_RUN}"
          } | tee "${EVI_DIR}/run_params.txt"

          python -V | tee "${EVI_DIR}/python_version.txt"

          # --- canonical paper session runner (deterministic) ---
          SESSION_OUT="${EVI_DIR}/session_out"
          mkdir -p "${SESSION_OUT}"
          echo "session_out=${SESSION_OUT}" | tee "${EVI_DIR}/paper_session_status.txt"

          # Help (for audit)
          python scripts/aiops/run_paper_trading_session.py --help > "${EVI_DIR}/paper_session_help.txt" 2>&1 || true

          # Execute deterministically on fixture spec
          python scripts/aiops/run_paper_trading_session.py \
            --spec "${{ github.event.inputs.spec }}" \
            --run-id "${{ github.event.inputs.run_id }}" \
            --outdir "${SESSION_OUT}" \
            --evidence 1 \
            > "${EVI_DIR}/paper_session_stdout.txt" 2> "${EVI_DIR}/paper_session_stderr.txt"

          # Expected outputs (fail if missing)
          test -f "${SESSION_OUT}/fills.json"
          test -f "${SESSION_OUT}/account.json"
          test -f "${SESSION_OUT}/evidence_manifest.json"

          # --- manifest + sha256 ---
          python - <<'PY'
          import json
          import os
          import hashlib
          from pathlib import Path

          evi_dir = Path(os.environ["EVI_DIR"])
          items = []
          for p in sorted(evi_dir.rglob("*")):
              if p.is_file():
                  h = hashlib.sha256(p.read_bytes()).hexdigest()
                  items.append({"path": str(p.relative_to(evi_dir)), "sha256": h, "bytes": p.stat().st_size})
          manifest = {
              "schema": "pt.audit.evidence.manifest.v1",
              "evidence_dir": str(evi_dir),
              "n_items": len(items),
              "items": items,
          }
          (evi_dir / "manifest.json").write_text(json.dumps(manifest, indent=2, sort_keys=True), encoding="utf-8")
          (evi_dir / "SHA256SUMS.txt").write_text("\n".join([f'{it["sha256"]}  {it["path"]}' for it in items]) + "\n", encoding="utf-8")
          print("MANIFEST_OK", len(items))
          PY

      - name: Upload artifact (audit evidence)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gh-paper-session-audit-evidence-py${{ matrix.python-version }}
          path: |
            out/ops/gh_paper_session_audit/**
