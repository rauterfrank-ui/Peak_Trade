name: paper-session-audit-evidence

on:
  workflow_dispatch:
    inputs:
      entrypoint:
        description: "Entrypoint: auto | scripts/aiops/run_paper_trading_session.py | runner_v1"
        required: true
        default: "auto"
        type: choice
        options:
          - auto
          - scripts/aiops/run_paper_trading_session.py
          - runner_v1
      note:
        description: "Optional operator note (audit metadata)"
        required: false
        default: ""
      require_entrypoint:
        description: "If true, fail the run when no entrypoint is found"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: read
  actions: write

jobs:
  paper_session:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    env:
      # Hard safety: no live/testnet
      PEAK_TRADE_TESTNET_ONLY: "false"
      PEAK_TRADE_LIVE_ENABLED: "false"
      PEAK_TRADE_LIVE_ARMED: "false"
      PT_DRY_RUN: "1"

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "${{ matrix.python-version }}"

      - name: Install
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run Paper Session (offline) + Audit Evidence
        env:
          EVI_DIR: "out/ops/gh_paper_session_audit/${{ github.run_id }}_${{ github.run_attempt }}_py${{ matrix.python-version }}"
        run: |
          set -euo pipefail

          mkdir -p "${EVI_DIR}"

          # --- audit metadata ---
          {
            echo "ts_utc=$(date -u +%Y%m%dT%H%M%SZ)"
            echo "workflow=${{ github.workflow }}"
            echo "run_id=${{ github.run_id }}"
            echo "run_attempt=${{ github.run_attempt }}"
            echo "job=${{ github.job }}"
            echo "ref=${{ github.ref }}"
            echo "sha=${{ github.sha }}"
            echo "actor=${{ github.actor }}"
            echo "entrypoint=${{ github.event.inputs.entrypoint }}"
            echo "note=${{ github.event.inputs.note }}"
            echo "require_entrypoint=${{ github.event.inputs.require_entrypoint }}"
            echo "safety.PEAK_TRADE_LIVE_ENABLED=${PEAK_TRADE_LIVE_ENABLED}"
            echo "safety.PEAK_TRADE_LIVE_ARMED=${PEAK_TRADE_LIVE_ARMED}"
            echo "safety.PT_DRY_RUN=${PT_DRY_RUN}"
          } | tee "${EVI_DIR}/run_params.txt"

          python -V | tee "${EVI_DIR}/python_version.txt"

          # --- resolve entrypoint ---
          EP="${{ github.event.inputs.entrypoint }}"
          FOUND="false"

          if [ "${EP}" = "auto" ]; then
            if [ -f scripts/aiops/run_paper_trading_session.py ]; then
              EP="scripts/aiops/run_paper_trading_session.py"
            else
              EP="runner_v1"
            fi
          fi

          echo "resolved_entrypoint=${EP}" | tee "${EVI_DIR}/resolved_entrypoint.txt"

          # --- execute (best-effort) ---
          if [ "${EP}" = "scripts/aiops/run_paper_trading_session.py" ] && [ -f scripts/aiops/run_paper_trading_session.py ]; then
            FOUND="true"
            (python scripts/aiops/run_paper_trading_session.py --help || true) > "${EVI_DIR}/paper_session_help.txt" 2>&1
            python scripts/aiops/run_paper_trading_session.py \
              --spec tests/fixtures/p7/paper_run_min_v0.json \
              --run-id "ci_audit_${{ github.run_id }}_py${{ matrix.python-version }}" \
              --outdir "${EVI_DIR}" \
              > "${EVI_DIR}/paper_session_stdout.txt" 2> "${EVI_DIR}/paper_session_stderr.txt"
          elif [ "${EP}" = "runner_v1" ] && [ -f src/execution/session/runner_v1.py ]; then
            FOUND="true"
            python - <<'PY' > "${EVI_DIR}/runner_v1_call.txt" 2>&1
import os
import json
from pathlib import Path

from src.execution.session.runner_v1 import ExecutionSessionContextV1, run_execution_session_v1

ts = __import__("datetime").datetime.now(__import__("datetime").timezone.utc).strftime("%Y%m%dT%H%M%SZ")
ctx = ExecutionSessionContextV1(
    mode="paper",
    adapters=("mock",),
    intents=("place_order",),
    market="BTC-USD",
    side="buy",
    qty=0.001,
    dry_run=True,
    ts_utc=ts,
)
res = run_execution_session_v1(ctx)
print("OK: run_execution_session_v1 returned keys:", sorted(res.keys()) if isinstance(res, dict) else type(res))
outp = Path(os.environ["EVI_DIR"]) / "runner_v1_result.json"
outp.write_text(json.dumps(res, indent=2, sort_keys=True, default=str), encoding="utf-8")
PY
          else
            echo "NO_ENTRYPOINT_FOUND" | tee "${EVI_DIR}/paper_session_status.txt"
          fi

          echo "found_entrypoint=${FOUND}" | tee -a "${EVI_DIR}/paper_session_status.txt"

          if [ "${FOUND}" = "false" ] && [ "${{ github.event.inputs.require_entrypoint }}" = "true" ]; then
            echo "ERROR: require_entrypoint=true but no entrypoint found" | tee -a "${EVI_DIR}/paper_session_status.txt"
            exit 2
          fi

          # --- manifest + sha256 ---
          python - <<'PY'
import json
import os
import hashlib
from pathlib import Path

evi_dir = Path(os.environ["EVI_DIR"])
items = []
for p in sorted(evi_dir.rglob("*")):
    if p.is_file():
        h = hashlib.sha256(p.read_bytes()).hexdigest()
        items.append({"path": str(p.relative_to(evi_dir)), "sha256": h, "bytes": p.stat().st_size})
manifest = {
    "schema": "pt.audit.evidence.manifest.v1",
    "evidence_dir": str(evi_dir),
    "n_items": len(items),
    "items": items,
}
(evi_dir / "manifest.json").write_text(json.dumps(manifest, indent=2, sort_keys=True), encoding="utf-8")
(evi_dir / "SHA256SUMS.txt").write_text("\n".join([f'{it["sha256"]}  {it["path"]}' for it in items]) + "\n", encoding="utf-8")
print("MANIFEST_OK", len(items))
PY

      - name: Upload artifact (audit evidence)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gh-paper-session-audit-evidence-py${{ matrix.python-version }}
          path: |
            out/ops/gh_paper_session_audit/**
