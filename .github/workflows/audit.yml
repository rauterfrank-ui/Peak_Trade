name: Audit

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 6 * * 1"   # Mo 06:00 UTC (Berlin i.d.R. 07:00/08:00)
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [ main ]
  merge_group:
    branches: [ main ]

jobs:
  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate PR final report formatting
        run: |
          chmod +x scripts/validate_pr_report_format.sh
          chmod +x scripts/automation/validate_all_pr_reports.sh
          bash scripts/automation/validate_all_pr_reports.sh

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install (minimal)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Determine whether audit is enforceable (docs-only scope)
        id: scope
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin main --depth=1

          CHANGED="$(git diff --name-only origin/main...HEAD || true)"
          echo "$CHANGED" > changed_files.txt

          # Dateien, die dependency-/runtime-relevant sind (Audit muss dann hart sein)
          if echo "$CHANGED" | grep -E -q '(^pyproject\.toml$|^uv\.lock$|^requirements.*\.txt$|^poetry\.lock$|^Pipfile(\.lock)?$|^setup\.cfg$|^setup\.py$)'; then
            echo "enforce=true" >> "$GITHUB_OUTPUT"
          else
            echo "enforce=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run pip-audit (conditional enforcement)
        id: audit
        shell: bash
        run: |
          set +e
          pip-audit -f json -o pip_audit.json
          RC=$?
          set -e

          echo "rc=$RC" >> "$GITHUB_OUTPUT"
          if [ "$RC" -eq 0 ]; then
            echo "‚úÖ pip-audit clean (0 vulnerabilities)."
            exit 0
          fi

          echo "‚ö†Ô∏è pip-audit found vulnerabilities (rc=$RC)."
          if [ "${{ steps.scope.outputs.enforce }}" = "false" ]; then
            echo "üìÑ Docs-only scope detected -> audit finding is non-blocking for this PR."
            echo "   See artifact 'pip-audit-output' for details."
            exit 0
          fi

          echo "‚ùå Dependency-relevant change detected -> audit is BLOCKING."
          cat pip_audit.json
          exit "$RC"

      - name: Run audit script (full checks)
        env:
          OPENAI_API_KEY: "DUMMY_CI_VALUE"
          LIVE_CONFIRM_TOKEN: "DUMMY_CI_VALUE"
        run: |
          chmod +x scripts/ops/run_audit.sh
          ./scripts/ops/run_audit.sh || echo "‚ö†Ô∏è run_audit.sh findings (non-blocking for pip-audit gate)"

      - name: Ops Merge Log Guard (non-blocking for legacy)
        run: |
          python scripts/audit/check_ops_merge_logs.py \
            || echo "‚ö†Ô∏è Ops merge log violations found (legacy) ‚Äî non-blocking"

      - name: Upload audit artifacts (even if failed)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-artifacts
          path: |
            reports/audit/**
            docs/ops/AUDIT_VALIDATION_NOTES.md
            pip_audit.json
            changed_files.txt
          if-no-files-found: warn
