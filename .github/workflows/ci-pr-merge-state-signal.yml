name: "PR Merge State Signal (Informational)"

# Purpose: Early visibility for BEHIND status on PRs
# Constraint: NEVER required, NEVER blocking, always SUCCESS
# Scope: Informational only - alerts operator to sync branch with main

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Ensure only one run per PR at a time
concurrency:
  group: pr-merge-state-signal-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  pr-merge-state-signal:
    name: "PR Merge State Signal"
    runs-on: ubuntu-latest

    # CRITICAL: Always report success (non-blocking)
    continue-on-error: true

    permissions:
      pull-requests: read
      contents: read

    steps:
      - name: "Get PR Merge State"
        id: pr_state
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const mergeStateStatus = pr.data.mergeable_state;
            const behindBy = pr.data.commits_behind_by || 0;
            const aheadBy = pr.data.commits_ahead_by || 0;
            const mergeable = pr.data.mergeable;

            console.log(`Merge State: ${mergeStateStatus}`);
            console.log(`Behind by: ${behindBy} commits`);
            console.log(`Ahead by: ${aheadBy} commits`);
            console.log(`Mergeable: ${mergeable}`);

            core.setOutput('merge_state', mergeStateStatus);
            core.setOutput('behind_by', behindBy);
            core.setOutput('ahead_by', aheadBy);
            core.setOutput('mergeable', mergeable);

      - name: "Generate Job Summary"
        run: |
          echo "# ðŸ” PR Merge State Signal" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Informational (not required for merge)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Current State" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Merge State:** \`${{ steps.pr_state.outputs.merge_state }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Behind main by:** ${{ steps.pr_state.outputs.behind_by }} commits" >> $GITHUB_STEP_SUMMARY
          echo "- **Ahead of main by:** ${{ steps.pr_state.outputs.ahead_by }} commits" >> $GITHUB_STEP_SUMMARY
          echo "- **Mergeable:** ${{ steps.pr_state.outputs.mergeable }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Conditionally add BEHIND warning
          if [ "${{ steps.pr_state.outputs.merge_state }}" = "behind" ] || [ "${{ steps.pr_state.outputs.behind_by }}" -gt "0" ]; then
            echo "## âš ï¸ Action Recommended" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your branch is **BEHIND** main by ${{ steps.pr_state.outputs.behind_by }} commit(s)." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommended Actions:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. **Sync your branch with main:**" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "   # Option A: Merge main into your branch" >> $GITHUB_STEP_SUMMARY
            echo "   git fetch origin main" >> $GITHUB_STEP_SUMMARY
            echo "   git merge origin/main" >> $GITHUB_STEP_SUMMARY
            echo "   " >> $GITHUB_STEP_SUMMARY
            echo "   # Option B: Rebase on main" >> $GITHUB_STEP_SUMMARY
            echo "   git fetch origin main" >> $GITHUB_STEP_SUMMARY
            echo "   git rebase origin/main" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "2. **Re-run validation after sync:**" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "   ./scripts/ops/pt_docs_gates_snapshot.sh --changed" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "3. **Push updated branch:**" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "   git push --force-with-lease" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Up to Date" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your branch is up to date with main. No action needed." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This check is **informational only** and does not block merging." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Documentation:** [docs/ops/runbooks/RUNBOOK_DOCS_GATES_OPERATOR_PACK_QUICKSTART.md](https://github.com/${{ github.repository }}/blob/main/docs/ops/runbooks/RUNBOOK_DOCS_GATES_OPERATOR_PACK_QUICKSTART.md)" >> $GITHUB_STEP_SUMMARY

      - name: "Always Succeed (Non-Blocking)"
        run: |
          echo "âœ… PR Merge State Signal complete (informational only)"
          exit 0
