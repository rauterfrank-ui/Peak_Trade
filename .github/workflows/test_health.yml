name: Test Health Automation

on:
  # Scheduled runs
  schedule:
    # TÃ¤glich um 06:00 UTC (07:00 CET)
    - cron: '0 6 * * *'
    # WÃ¶chentlich Sonntags um 03:00 UTC (04:00 CET)
    - cron: '0 3 * * 0'

  # Manueller Trigger
  workflow_dispatch:
    inputs:
      profile:
        description: 'Test Health Profile to run'
        required: false
        default: 'daily_quick'
        type: choice
        options:
          - daily_quick
          - weekly_core
          - full_suite
          - r_and_d_experimental
          - demo_simple

  # CI-Gate: Bei Pull Requests und Push auf main
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  merge_group:

jobs:
  # ===========================================================================
  # CI Health Gate (weekly_core)
  # ===========================================================================
  # Dieser Job lÃ¤uft bei jedem PR und Push auf main als Quality Gate.
  # Er fÃ¼hrt das weekly_core-Profil aus und schlÃ¤gt HART fehl, wenn
  # mindestens ein Check fehlschlÃ¤gt.
  # ===========================================================================
  ci-health-gate:
    name: CI Health Gate (weekly_core)
    runs-on: ubuntu-latest
    # Nur bei Push/PR triggern, nicht bei Schedules
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pandas numpy

      - name: ðŸ¥ Run Test Health Profile (weekly_core)
        id: health_check
        run: |
          set -e  # Fail-fast bei Fehler
          python scripts/run_test_health_profile.py --profile weekly_core
        # WICHTIG: Kein continue-on-error! Job soll hart fehlschlagen.

      - name: ðŸ“Š Upload Test Health Report (Artifacts)
        uses: actions/upload-artifact@v4
        if: always()  # Auch bei Failure Reports hochladen
        with:
          name: ci-health-report-${{ github.run_number }}
          path: reports/test_health/
          retention-days: 30

      - name: ðŸ“ˆ Display Health Summary
        if: always()
        run: |
          echo "======================================================================"
          echo "ðŸ“‹ Test Health Report Summary"
          echo "======================================================================"

          # Finde letzten Report
          LATEST_DIR=$(ls -t reports/test_health/ | grep -v history.json | head -1)

          if [ -d "reports/test_health/${LATEST_DIR}" ]; then
            # JSON-Summary parsen
            SUMMARY_JSON="reports/test_health/${LATEST_DIR}/summary.json"

            if [ -f "$SUMMARY_JSON" ]; then
              echo "ðŸ“„ Report Path: reports/test_health/${LATEST_DIR}/"
              echo ""

              # Health-Score und Check-Zahlen extrahieren
              HEALTH_SCORE=$(python -c "import json; d=json.load(open('${SUMMARY_JSON}')); print(f\"{d['health_score']:.1f}\")")
              PASSED=$(python -c "import json; d=json.load(open('${SUMMARY_JSON}')); print(d['passed_checks'])")
              FAILED=$(python -c "import json; d=json.load(open('${SUMMARY_JSON}')); print(d['failed_checks'])")
              SKIPPED=$(python -c "import json; d=json.load(open('${SUMMARY_JSON}')); print(d['skipped_checks'])")

              echo "ðŸ¥ Health Score:    ${HEALTH_SCORE} / 100.0"
              echo "âœ… Passed Checks:   ${PASSED}"
              echo "âŒ Failed Checks:   ${FAILED}"
              echo "â­ï¸  Skipped Checks:  ${SKIPPED}"
              echo ""

              # Ampel-Logik
              if (( $(echo "$HEALTH_SCORE >= 80" | bc -l) )); then
                echo "ðŸŸ¢ Status: HEALTHY (Score >= 80)"
              elif (( $(echo "$HEALTH_SCORE >= 50" | bc -l) )); then
                echo "ðŸŸ¡ Status: DEGRADED (50 <= Score < 80)"
              else
                echo "ðŸ”´ Status: CRITICAL (Score < 50)"
              fi

              echo ""
              echo "ðŸ“„ Full Report: siehe CI-Artefakte (ci-health-report-${{ github.run_number }})"
            else
              echo "âš ï¸  summary.json nicht gefunden"
            fi

            # Markdown-Summary anzeigen (falls vorhanden)
            SUMMARY_MD="reports/test_health/${LATEST_DIR}/summary.md"
            if [ -f "$SUMMARY_MD" ]; then
              echo ""
              echo "======================================================================"
              echo "ðŸ“ Markdown Summary:"
              echo "======================================================================"
              cat "$SUMMARY_MD"
            fi
          else
            echo "âš ï¸  Kein Report-Verzeichnis gefunden"
          fi

          echo "======================================================================"

  daily-health-check:
    name: Daily Quick Health Check
    runs-on: ubuntu-latest
    # Nur bei tÃ¤glichem Schedule (nicht bei PR/Push)
    if: github.event.schedule == '0 6 * * *'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          # Core dependencies fÃ¼r Tests
          pip install pytest pandas numpy

      - name: Run Daily Quick Health Check
        run: |
          python scripts/run_test_health_profile.py --profile daily_quick
        continue-on-error: true

      - name: Upload Daily Health Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: daily-health-report-${{ github.run_number }}
          path: reports/test_health/
          retention-days: 30

      - name: Check Health Score
        run: |
          # Lese letzten Report
          LATEST_DIR=$(ls -t reports/test_health/ | grep -v history.json | head -1)
          HEALTH_SCORE=$(python -c "import json; data=json.load(open('reports/test_health/${LATEST_DIR}/summary.json')); print(data['health_score'])")
          echo "Health Score: ${HEALTH_SCORE}"

          # Fail wenn Score < 80 (fÃ¼r daily_quick sollte es 100 sein)
          if (( $(echo "$HEALTH_SCORE < 80" | bc -l) )); then
            echo "âŒ Health Score too low: ${HEALTH_SCORE} < 80"
            exit 1
          else
            echo "âœ… Health Score OK: ${HEALTH_SCORE} >= 80"
          fi

  weekly-health-check:
    name: Weekly Core Health Check
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 3 * * 0'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pandas numpy

      - name: Run Weekly Core Health Check
        run: |
          python scripts/run_test_health_profile.py --profile weekly_core
        continue-on-error: true

      - name: Upload Weekly Health Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: weekly-health-report-${{ github.run_number }}
          path: reports/test_health/
          retention-days: 90

      - name: Show Health History
        run: |
          python scripts/show_test_health_history.py --profile weekly_core

  manual-health-check:
    name: Manual Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pandas numpy

      - name: Run Health Check (${{ github.event.inputs.profile }})
        run: |
          python scripts/run_test_health_profile.py --profile ${{ github.event.inputs.profile }}
        continue-on-error: true

      - name: Upload Health Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: health-report-${{ github.event.inputs.profile }}-${{ github.run_number }}
          path: reports/test_health/
          retention-days: 30

      - name: Show History
        run: |
          python scripts/show_test_health_history.py --all

  r-and-d-health-check:
    name: R&D Experimental Health Check (Weekly)
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 3 * * 0'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pandas numpy

      - name: Run R&D Health Check
        run: |
          python scripts/run_test_health_profile.py --profile r_and_d_experimental
        continue-on-error: true

      - name: Upload R&D Health Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: r-and-d-health-report-${{ github.run_number }}
          path: reports/test_health/
          retention-days: 90

      - name: Check R&D Health Score
        run: |
          LATEST_DIR=$(ls -t reports/test_health/ | grep -v history.json | head -1)
          HEALTH_SCORE=$(python -c "import json; data=json.load(open('reports/test_health/${LATEST_DIR}/summary.json')); print(data['health_score'])")
          echo "R&D Health Score: ${HEALTH_SCORE}"

          # R&D erlaubt niedrigeren Score (70%)
          if (( $(echo "$HEALTH_SCORE < 70" | bc -l) )); then
            echo "âš ï¸ R&D Health Score below threshold: ${HEALTH_SCORE} < 70"
            exit 1
          else
            echo "âœ… R&D Health Score OK: ${HEALTH_SCORE} >= 70"
          fi
