name: CI / Export Pack Download + Verify

"on":
  workflow_dispatch:
    inputs:
      export_id:
        description: "Optional: pin a specific export_id (else latest)."
        required: false
        default: ""
  pull_request:

jobs:
  export-pack-verify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Skip on PR when not enabled (vars); always run on workflow_dispatch (secrets not allowed in job.if)
    if: github.event_name == 'workflow_dispatch' || vars.PT_EXPORT_CI_ENABLED == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets/vars
        env:
          PT_RCLONE_CONF_B64: ${{ secrets.PT_RCLONE_CONF_B64 }}
          PT_EXPORT_REMOTE: ${{ secrets.PT_EXPORT_REMOTE }}
          PT_EXPORT_PREFIX: ${{ secrets.PT_EXPORT_PREFIX }}
        run: |
          missing=0
          if [ -z "${PT_RCLONE_CONF_B64}" ]; then echo "ERR: missing secret PT_RCLONE_CONF_B64"; missing=1; fi
          if [ -z "${PT_EXPORT_REMOTE}" ]; then echo "ERR: missing secret PT_EXPORT_REMOTE"; missing=1; fi
          if [ -z "${PT_EXPORT_PREFIX}" ]; then echo "ERR: missing secret PT_EXPORT_PREFIX"; missing=1; fi
          if [ "${missing}" -ne 0 ]; then
            echo "---"
            echo "How to fix:"
            echo "  1) Add repo secrets: PT_RCLONE_CONF_B64, PT_EXPORT_REMOTE, PT_EXPORT_PREFIX"
            echo "  2) Then re-run workflow_dispatch"
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              exit 2
            else
              echo "INFO: pull_request run will SKIP (non-blocking) until secrets are configured"
              exit 0
            fi
          fi


      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone

      - name: Materialize rclone config (read-only)
        env:
          PT_RCLONE_CONF_B64: ${{ secrets.PT_RCLONE_CONF_B64 }}
        run: |
          test -n "${PT_RCLONE_CONF_B64}"
          mkdir -p "${HOME}/.config/rclone"
          echo "${PT_RCLONE_CONF_B64}" | base64 -d > "${HOME}/.config/rclone/rclone.conf"
          rclone version

      - name: Seed export pack locally (fallback when bucket empty)
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        env:
          PT_EXPORT_REMOTE: ${{ secrets.PT_EXPORT_REMOTE }}
          PT_EXPORT_PREFIX: ${{ secrets.PT_EXPORT_PREFIX }}
        run: |
          set -euo pipefail
          TS="$(date -u +%Y%m%dT%H%M%SZ)"
          EID="export_seed_${TS}"
          LOCAL="out/ops/exports_ci_seed/${EID}"
          mkdir -p "${LOCAL}/data"
          printf '{"export_id":"%s","created_at":"%s","note":"ci seed export (auto)"}\n' "${EID}" "${TS}" > "${LOCAL}/manifest.json"
          printf "seed payload %s\n" "${TS}" > "${LOCAL}/data/payload.txt"
          if command -v sha256sum >/dev/null 2>&1; then
            (cd "${LOCAL}" && sha256sum manifest.json data/payload.txt | awk '{print $1"  "$2}' > SHA256SUMS.stable.txt)
          else
            (cd "${LOCAL}" && shasum -a 256 manifest.json data/payload.txt | awk '{print $1"  "$2}' > SHA256SUMS.stable.txt)
          fi
          REMOTE_DIR="${EID}"
          if [[ "${REMOTE_DIR}" != export_* ]]; then
            REMOTE_DIR="export_${REMOTE_DIR}"
          fi
          rclone copy "${LOCAL}" "${PT_EXPORT_REMOTE}/${PT_EXPORT_PREFIX}/${REMOTE_DIR}" -P
          echo "${EID}" > out/ops/exports_ci_seed/SEEDED_EXPORT_ID.txt
          echo "Seeded EID=${EID}"

      - name: Resolve export_id (pinned or latest)
        id: resolve
        env:
          PT_EXPORT_REMOTE: ${{ secrets.PT_EXPORT_REMOTE }}
          PT_EXPORT_PREFIX: ${{ secrets.PT_EXPORT_PREFIX }}
          PT_EXPORT_ID_SECRET: ${{ secrets.PT_EXPORT_ID }}
          PT_EXPORT_ID_INPUT: ${{ github.event.inputs.export_id }}
        run: |
          if test -f out/ops/exports_ci_seed/SEEDED_EXPORT_ID.txt; then
            PT_EXPORT_ID_INPUT="$(cat out/ops/exports_ci_seed/SEEDED_EXPORT_ID.txt)"
          fi
          test -n "${PT_EXPORT_REMOTE}"
          test -n "${PT_EXPORT_PREFIX}"

          PIN="${PT_EXPORT_ID_INPUT}"
          if [ -z "${PIN}" ]; then
            PIN="${PT_EXPORT_ID_SECRET}"
          fi

          if [ -n "${PIN}" ]; then
            echo "export_id=${PIN}" >> "${GITHUB_OUTPUT}"
            echo "Resolved pinned export_id=${PIN}"
            exit 0
          fi

          # List directories under prefix and pick lexicographically last (timestamped IDs recommended)
          # Expect layout: <remote>/<prefix>/export_<export_id>/
          rclone lsf "${PT_EXPORT_REMOTE}/${PT_EXPORT_PREFIX}" --dirs-only --max-depth 1 | sort | tail -n1 > latest_dir.txt
          LATEST_DIR="$(cat latest_dir.txt | tr -d '\n')"
          test -n "${LATEST_DIR}"

          # Strip leading "export_" and trailing "/"
          EID="${LATEST_DIR%/}"
          EID="${EID#export_}"

          echo "export_id=${EID}" >> "${GITHUB_OUTPUT}"
          echo "Resolved latest export_id=${EID} (dir=${LATEST_DIR})"

      - name: Download export pack
        env:
          PT_EXPORT_REMOTE: ${{ secrets.PT_EXPORT_REMOTE }}
          PT_EXPORT_PREFIX: ${{ secrets.PT_EXPORT_PREFIX }}
        run: |
          EID="${{ steps.resolve.outputs.export_id }}"
          test -n "${EID}"
          REMOTE_DIR="${EID}"
          if [[ "${REMOTE_DIR}" != export_* ]]; then
            REMOTE_DIR="export_${REMOTE_DIR}"
          fi
          OUT="out/ops/exports_ci/${REMOTE_DIR}"
          mkdir -p "${OUT}"

          # Copy full pack dir
          rclone copy "${PT_EXPORT_REMOTE}/${PT_EXPORT_PREFIX}/${REMOTE_DIR}" "${OUT}" -P

          # Basic presence
          test -s "${OUT}/manifest.json"
          test -s "${OUT}/SHA256SUMS.stable.txt"

      - name: Verify SHA256SUMS (contract)
        run: |
          EID="${{ steps.resolve.outputs.export_id }}"
          REMOTE_DIR="${EID}"
          if [[ "${REMOTE_DIR}" != export_* ]]; then
            REMOTE_DIR="export_${REMOTE_DIR}"
          fi
          OUT="out/ops/exports_ci/${REMOTE_DIR}"
          cd "${OUT}"

          # Prefer sha256sum on ubuntu
          sha256sum -c SHA256SUMS.stable.txt

      - name: Show manifest summary
        run: |
          EID="${{ steps.resolve.outputs.export_id }}"
          REMOTE_DIR="${EID}"
          if [[ "${REMOTE_DIR}" != export_* ]]; then
            REMOTE_DIR="export_${REMOTE_DIR}"
          fi
          OUT="out/ops/exports_ci/${REMOTE_DIR}"
          export OUT
          python3 -c "import json,os; from pathlib import Path; p=Path(os.environ['OUT'])/'manifest.json'; d=json.loads(p.read_text()); print('schema_version:', d.get('schema_version')); print('export_id:', d.get('export_id')); print('created_at_utc:', d.get('created_at_utc')); print('source:', d.get('source')); print('files_count:', len(d.get('files',[])))"
