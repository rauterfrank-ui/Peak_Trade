name: Auto-create PR (missing-features-and-ai-matrix-gate)

on:
  push:
    branches:
      - feat/missing-features-and-ai-matrix-gate

permissions:
  contents: read
  pull-requests: write

jobs:
  create_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Create PR if missing
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const owner = context.repo.owner;
              const repo = context.repo.repo;
              const branch = context.ref.replace('refs/heads/', '');
              const base = 'main';

              const existing = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open',
                base,
                head: `${owner}:${branch}`,
              });

              if (existing.data.length > 0) {
                core.info(`PR already exists: ${existing.data[0].html_url}`);
                return;
              }

              const title = 'docs+governance: runbook index, missing-features sync, ai matrix gate';
              const body = [
                '## Summary',
                '',
                '1) Runbook indexed + added',
                '- Adds Cursor MA open-points runbook (A–J) and index entries.',
                '',
                '2) Missing-features status synced',
                '- Updates missing-features doc to current repo state (research track).',
                '',
                '3) AI matrix consistency gate refined',
                '- Updates scripts/governance/ai_matrix_consistency_gate.sh',
                '',
                '## Validation',
                '- Guardrails: only expected paths changed (docs + governance gate).',
              ].join('\n');

              const pr = await github.rest.pulls.create({
                owner,
                repo,
                title,
                head: branch,
                base,
                body,
                maintainer_can_modify: true,
              });

              core.info(`PR created: ${pr.data.html_url}`);
            } catch (err) {
              core.setFailed(`Auto PR creation failed: ${err?.message || err}`);
              core.info('If this is a permissions issue: Settings → Actions → General → Workflow permissions → Read and write permissions + allow PR create/approve.');
            }
