name: PR-CC / AWS Export Smoke

on:
  schedule:
    - cron: "17 3 * * *"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: prcc-aws-export-smoke-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  aws-export-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install rclone
        run: |
          sudo apt-get update -y
          sudo apt-get install -y rclone
          rclone version

      - name: Run smoke (read-only)
        env:
          PT_EXPORT_REMOTE: ${{ secrets.PT_EXPORT_REMOTE }}
          PT_EXPORT_PREFIX: ${{ secrets.PT_EXPORT_PREFIX }}
          PT_RCLONE_CONF_B64: ${{ secrets.PT_RCLONE_CONF_B64 }}
        run: |
          python3 scripts/ops/aws_export_smoke.py || true
          test -f reports/status/aws_export_smoke.json
          test -f reports/status/aws_export_smoke.md

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aws_export_smoke
          path: reports/status/aws_export_smoke.*
          retention-days: 14
