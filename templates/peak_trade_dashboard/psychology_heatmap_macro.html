<!-- templates/peak_trade_dashboard/psychology_heatmap_macro.html -->
<!--
  Psychologie-Heatmap Macro
  =========================

  Wiederverwendbare Jinja2-Macro fÃ¼r die Psychologie-Heatmap.
  Kann in verschiedenen Templates eingebunden werden.

  Verwendung:
    {% from 'psychology_heatmap_macro.html' import psychology_heatmap %}
    {{ psychology_heatmap(heatmap_rows, show_legend=True, show_notes=True) }}

  Parameter:
    - heatmap_rows: Liste von serialisierten Heatmap-Rows
    - show_legend: Boolean, ob Legende angezeigt werden soll (default: True)
    - show_notes: Boolean, ob Interpretations-Hinweise angezeigt werden (default: True)
-->

{% macro psychology_heatmap(heatmap_rows, show_legend=True, show_notes=True) %}
<section class="bg-gradient-to-br from-slate-900/80 via-slate-900/60 to-slate-900/80 rounded-2xl border border-slate-800 p-6">

  {# Header #}
  <div class="mb-4">
    <div class="flex items-center gap-3 mb-2">
      <span class="text-2xl">ðŸ§ </span>
      <h2 class="text-xl font-bold text-slate-100">Psychologie-Heatmap</h2>
    </div>
    <p class="text-sm text-slate-400 leading-relaxed">
      Diese Heatmap fasst psychologische Muster Ã¼ber alle betrachteten
      Szenarien / Sessions zusammen. HÃ¶here Werte bedeuten stÃ¤rkere
      AusprÃ¤gung des jeweiligen â€žProblems" (0 = kein Thema, 3 = starkes Thema).
    </p>
  </div>

  {# Legende #}
  {% if show_legend %}
  <div class="mb-4 flex flex-wrap items-center gap-2 pb-4 border-b border-slate-800/50">
    <span class="text-xs font-semibold text-slate-400 mr-2">SKALA:</span>
    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-slate-950 text-slate-300 border border-slate-700 text-xs">
      <span class="w-2 h-2 rounded-full bg-slate-700"></span>
      0 â€“ kein Thema
    </span>
    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-blue-950 text-blue-300 border border-blue-700 text-xs">
      <span class="w-2 h-2 rounded-full bg-blue-500"></span>
      1 â€“ leicht
    </span>
    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-amber-950 text-amber-300 border border-amber-600 text-xs">
      <span class="w-2 h-2 rounded-full bg-amber-500"></span>
      2 â€“ mittel
    </span>
    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-rose-950 text-rose-300 border border-rose-600 text-xs">
      <span class="w-2 h-2 rounded-full bg-rose-500"></span>
      3 â€“ stark
    </span>
  </div>
  {% endif %}

  {# Heatmap-Tabelle #}
  <div class="overflow-x-auto -mx-2 px-2">
    <table class="w-full border-collapse text-sm">
      <thead>
        <tr class="border-b-2 border-slate-700">
          <th class="text-left py-3 px-3 font-semibold text-slate-200 bg-slate-900/60 sticky left-0 z-10">
            Kontext / Cluster
          </th>
          <th class="text-center py-3 px-3 font-semibold text-slate-200 bg-slate-900/60">
            <div>FOMO</div>
            <div class="text-xs font-normal text-slate-500 mt-0.5">â€žHinterherjagen"</div>
          </th>
          <th class="text-center py-3 px-3 font-semibold text-slate-200 bg-slate-900/60">
            <div>Verlustangst</div>
            <div class="text-xs font-normal text-slate-500 mt-0.5">â€žNicht verlieren"</div>
          </th>
          <th class="text-center py-3 px-3 font-semibold text-slate-200 bg-slate-900/60">
            <div>ImpulsivitÃ¤t</div>
            <div class="text-xs font-normal text-slate-500 mt-0.5">Spontan-Trades</div>
          </th>
          <th class="text-center py-3 px-3 font-semibold text-slate-200 bg-slate-900/60">
            <div>ZÃ¶gern</div>
            <div class="text-xs font-normal text-slate-500 mt-0.5">Signale verpasst</div>
          </th>
          <th class="text-center py-3 px-3 font-semibold text-slate-200 bg-slate-900/60">
            <div>Regelbruch</div>
            <div class="text-xs font-normal text-slate-500 mt-0.5">Setup ignoriert</div>
          </th>
        </tr>
      </thead>
      <tbody>
        {% for row in heatmap_rows %}
        <tr class="border-b border-slate-800/50 hover:bg-slate-800/20 transition-colors">
          {# Row Label (Cluster Name) #}
          <td class="py-2.5 px-3 font-medium text-slate-200 bg-slate-900/40 sticky left-0 z-10">
            {{ row.name }}
          </td>

          {# FOMO Cell #}
          <td class="py-2.5 px-3 text-center font-semibold tabular-nums
            {% if row.fomo.heat_level == 0 %}bg-slate-950 text-slate-400
            {% elif row.fomo.heat_level == 1 %}bg-blue-950/70 text-blue-200 border-l border-r border-blue-800/50
            {% elif row.fomo.heat_level == 2 %}bg-amber-950/70 text-amber-100 border-l border-r border-amber-700/50
            {% elif row.fomo.heat_level == 3 %}bg-rose-950/70 text-rose-100 border-l border-r border-rose-700/50
            {% endif %}">
            {{ row.fomo.display_value }}
          </td>

          {# Loss Fear Cell #}
          <td class="py-2.5 px-3 text-center font-semibold tabular-nums
            {% if row.loss_fear.heat_level == 0 %}bg-slate-950 text-slate-400
            {% elif row.loss_fear.heat_level == 1 %}bg-blue-950/70 text-blue-200 border-l border-r border-blue-800/50
            {% elif row.loss_fear.heat_level == 2 %}bg-amber-950/70 text-amber-100 border-l border-r border-amber-700/50
            {% elif row.loss_fear.heat_level == 3 %}bg-rose-950/70 text-rose-100 border-l border-r border-rose-700/50
            {% endif %}">
            {{ row.loss_fear.display_value }}
          </td>

          {# Impulsivity Cell #}
          <td class="py-2.5 px-3 text-center font-semibold tabular-nums
            {% if row.impulsivity.heat_level == 0 %}bg-slate-950 text-slate-400
            {% elif row.impulsivity.heat_level == 1 %}bg-blue-950/70 text-blue-200 border-l border-r border-blue-800/50
            {% elif row.impulsivity.heat_level == 2 %}bg-amber-950/70 text-amber-100 border-l border-r border-amber-700/50
            {% elif row.impulsivity.heat_level == 3 %}bg-rose-950/70 text-rose-100 border-l border-r border-rose-700/50
            {% endif %}">
            {{ row.impulsivity.display_value }}
          </td>

          {# Hesitation Cell #}
          <td class="py-2.5 px-3 text-center font-semibold tabular-nums
            {% if row.hesitation.heat_level == 0 %}bg-slate-950 text-slate-400
            {% elif row.hesitation.heat_level == 1 %}bg-blue-950/70 text-blue-200 border-l border-r border-blue-800/50
            {% elif row.hesitation.heat_level == 2 %}bg-amber-950/70 text-amber-100 border-l border-r border-amber-700/50
            {% elif row.hesitation.heat_level == 3 %}bg-rose-950/70 text-rose-100 border-l border-r border-rose-700/50
            {% endif %}">
            {{ row.hesitation.display_value }}
          </td>

          {# Rule Break Cell #}
          <td class="py-2.5 px-3 text-center font-semibold tabular-nums
            {% if row.rule_break.heat_level == 0 %}bg-slate-950 text-slate-400
            {% elif row.rule_break.heat_level == 1 %}bg-blue-950/70 text-blue-200 border-l border-r border-blue-800/50
            {% elif row.rule_break.heat_level == 2 %}bg-amber-950/70 text-amber-100 border-l border-r border-amber-700/50
            {% elif row.rule_break.heat_level == 3 %}bg-rose-950/70 text-rose-100 border-l border-r border-rose-700/50
            {% endif %}">
            {{ row.rule_break.display_value }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# Interpretations-Hinweise #}
  {% if show_notes %}
  <div class="mt-6 pt-4 border-t border-slate-800/50">
    <div class="bg-slate-950/60 rounded-xl border border-slate-700 p-4">
      <div class="flex items-start gap-3">
        <span class="text-xl mt-0.5">ðŸ’¡</span>
        <div class="flex-1">
          <p class="text-sm font-semibold text-slate-200 mb-2">Interpretation:</p>
          <p class="text-sm text-slate-400 leading-relaxed">
            Ziel ist nicht â€žalles auf 0", sondern <strong class="text-slate-300">Bewusstsein Ã¼ber typische
            Trigger</strong>. Nutze die Heatmap, um gezielt Drills fÃ¼r die Cluster
            mit hohen Werten zu planen (z.&nbsp;B. spezielle FOMO-Drills fÃ¼r
            Breakouts, separate Angst-Drills fÃ¼r Counter-Trend-Setups etc.).
          </p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

</section>
{% endmacro %}


{# ============================================================================
   Kompakte Variante fÃ¼r Dashboard-Ãœbersicht
   ============================================================================ #}

{% macro psychology_heatmap_compact(heatmap_rows) %}
<div class="bg-slate-900/60 rounded-xl border border-slate-800 p-4">
  <h3 class="text-sm font-semibold text-slate-200 flex items-center gap-2 mb-3">
    <span>ðŸ§ </span> Psychologie-Muster
  </h3>

  <div class="space-y-2">
    {% for row in heatmap_rows %}
    <div class="flex items-center gap-2">
      <span class="text-xs text-slate-400 w-32 truncate" title="{{ row.name }}">
        {{ row.name }}
      </span>
      <div class="flex gap-1 flex-1">
        {% for metric in ['fomo', 'loss_fear', 'impulsivity', 'hesitation', 'rule_break'] %}
        <div class="flex-1 h-6 rounded flex items-center justify-center text-xs font-semibold
          {% if row[metric].heat_level == 0 %}bg-slate-800 text-slate-500
          {% elif row[metric].heat_level == 1 %}bg-blue-900/50 text-blue-300
          {% elif row[metric].heat_level == 2 %}bg-amber-900/50 text-amber-300
          {% elif row[metric].heat_level == 3 %}bg-rose-900/50 text-rose-300
          {% endif %}">
          {{ row[metric].display_value }}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="mt-3 pt-3 border-t border-slate-800/50 flex justify-between items-center text-xs">
    <span class="text-slate-500">
      <span class="inline-block w-2 h-2 rounded-full bg-slate-700 mr-1"></span> 0
      <span class="inline-block w-2 h-2 rounded-full bg-blue-600 mx-1"></span> 1
      <span class="inline-block w-2 h-2 rounded-full bg-amber-600 mx-1"></span> 2
      <span class="inline-block w-2 h-2 rounded-full bg-rose-600 mx-1"></span> 3
    </span>
    <a href="/trigger_training/psychology" class="text-sky-400 hover:text-sky-300 transition-colors">
      Details â†’
    </a>
  </div>
</div>
{% endmacro %}
