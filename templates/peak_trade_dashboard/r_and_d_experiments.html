<!-- templates/peak_trade_dashboard/r_and_d_experiments.html -->
<!-- 
  R&D Experiments Overview (Phase 76)
  ===================================
  Read-only √úbersicht aller R&D-Experimente.
  
  Struktur:
  1. Header / Intro
  2. Stats-Kacheln (KPIs)
  3. Filter-Form + aktive Filter-Badges
  4. Experiments-Tabelle
  5. Footer-Hinweis
-->
{% extends "base.html" %}

{# ========================================================================= #}
{# MACROS - Wiederverwendbare Komponenten                                    #}
{# ========================================================================= #}

{# Stat-Kachel f√ºr KPI-Anzeige #}
{% macro stat_tile(label, value, color_class="text-slate-100", format=None) %}
<div class="bg-slate-900/60 rounded-xl border border-slate-800 px-4 py-3 min-w-0">
  <p class="text-xs text-slate-400 truncate">{{ label }}</p>
  <p class="text-2xl font-bold {{ color_class }} tabular-nums">
    {%- if format == 'percent' -%}
      {{ "%.2f%%"|format(value * 100) }}
    {%- elif format == 'decimal' -%}
      {{ "%.2f"|format(value) }}
    {%- else -%}
      {{ value }}
    {%- endif -%}
  </p>
</div>
{% endmacro %}

{# Filter-Badge Komponente #}
{% macro filter_badge(label, value, color="sky") %}
<span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-{{ color }}-500/10 text-{{ color }}-300 border border-{{ color }}-500/30">
  <span class="font-medium">{{ label }}:</span> {{ value }}
</span>
{% endmacro %}

{# Status-Badge Komponente #}
{% macro status_badge(status) %}
{% if status == "ok" %}
<span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/30">
  <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
  OK
</span>
{% elif status == "no_trades" %}
<span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-slate-500/10 text-slate-400 border border-slate-500/30">
  0 Trades
</span>
{% elif status == "failed" %}
<span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-rose-500/10 text-rose-400 border border-rose-500/30">
  <span class="w-1.5 h-1.5 rounded-full bg-rose-400"></span>
  Fail
</span>
{% else %}
<span class="text-xs text-slate-400">{{ status or '-' }}</span>
{% endif %}
{% endmacro %}

{# ========================================================================= #}
{# CONTENT BLOCK                                                             #}
{# ========================================================================= #}

{% block content %}
<div class="space-y-6">

  {# ======================================================================= #}
  {# SECTION 1: Header / Intro                                               #}
  {# ======================================================================= #}
  <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-slate-100">R&D Experiments Overview</h1>
      <p class="text-sm text-slate-400 mt-1">
        Read-only √úbersicht der R&D-Experimente aus 
        <code class="bg-slate-800 px-1.5 py-0.5 rounded text-slate-300 text-xs">reports/r_and_d_experiments/</code>
      </p>
    </div>
    <a 
      href="/" 
      class="self-start text-xs px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors inline-flex items-center gap-1"
    >
      <span>‚Üê</span>
      <span>Zur√ºck zum Dashboard</span>
    </a>
  </header>

  {# ======================================================================= #}
  {# SECTION 2: Stats-Kacheln (KPIs)                                         #}
  {# ======================================================================= #}
  {% if stats %}
  <section aria-label="Statistiken">
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
      {{ stat_tile("Experimente gesamt", stats.total_experiments) }}
      {{ stat_tile("Mit Trades", stats.experiments_with_trades, "text-emerald-300") }}
      {{ stat_tile("Presets", stats.unique_presets, "text-sky-300") }}
      {{ stat_tile("√ò Sharpe", stats.avg_sharpe, "text-amber-300", "decimal") }}
      {% set return_color = "text-emerald-300" if stats.avg_return >= 0 else "text-rose-400" %}
      {{ stat_tile("√ò Return", stats.avg_return, return_color, "percent") }}
    </div>
  </section>
  {% endif %}

  {# ======================================================================= #}
  {# SECTION 3: Filter-Form + aktive Filter                                  #}
  {# ======================================================================= #}
  <section aria-label="Filter">
    <form method="GET" action="/r_and_d" class="bg-slate-900/60 rounded-xl border border-slate-800 p-4">
      
      {# Filter-Inputs Grid #}
      <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-5">
        
        {# Preset Filter #}
        <div class="flex flex-col gap-1">
          <label for="filter-preset" class="text-xs uppercase tracking-wide text-slate-400 font-medium">
            Preset
          </label>
          <input
            id="filter-preset"
            type="text"
            name="preset"
            value="{{ filters.preset or '' }}"
            class="rounded-lg px-3 py-2 bg-slate-950 border border-slate-700 text-sm text-slate-100 placeholder-slate-500 focus:border-sky-500 focus:ring-1 focus:ring-sky-500/30 focus:outline-none transition-colors"
            placeholder="z.B. ehlers_super_smoother_v1"
          />
        </div>

        {# Strategy Filter #}
        <div class="flex flex-col gap-1">
          <label for="filter-strategy" class="text-xs uppercase tracking-wide text-slate-400 font-medium">
            Strategy
          </label>
          <input
            id="filter-strategy"
            type="text"
            name="strategy"
            value="{{ filters.strategy or '' }}"
            class="rounded-lg px-3 py-2 bg-slate-950 border border-slate-700 text-sm text-slate-100 placeholder-slate-500 focus:border-sky-500 focus:ring-1 focus:ring-sky-500/30 focus:outline-none transition-colors"
            placeholder="z.B. armstrong_cycle"
          />
        </div>

        {# Tag-Substring Filter #}
        <div class="flex flex-col gap-1">
          <label for="filter-tag" class="text-xs uppercase tracking-wide text-slate-400 font-medium">
            Tag-Substring
          </label>
          <input
            id="filter-tag"
            type="text"
            name="tag_substr"
            value="{{ filters.tag_substr or '' }}"
            class="rounded-lg px-3 py-2 bg-slate-950 border border-slate-700 text-sm text-slate-100 placeholder-slate-500 focus:border-sky-500 focus:ring-1 focus:ring-sky-500/30 focus:outline-none transition-colors"
            placeholder="z.B. wave2"
          />
        </div>

        {# With Trades Checkbox #}
        <div class="flex flex-col gap-1">
          <span class="text-xs uppercase tracking-wide text-slate-400 font-medium">Optionen</span>
          <label class="inline-flex items-center gap-2 py-2 cursor-pointer group">
            <input
              type="checkbox"
              name="with_trades"
              value="true"
              {% if filters.with_trades %}checked{% endif %}
              class="rounded border-slate-600 bg-slate-950 text-sky-500 focus:ring-sky-500 focus:ring-offset-0 cursor-pointer"
            />
            <span class="text-sm text-slate-300 group-hover:text-slate-200 transition-colors">
              Nur mit Trades
            </span>
          </label>
        </div>

        {# Action Buttons #}
        <div class="flex flex-col gap-1 justify-end">
          <span class="text-xs uppercase tracking-wide text-slate-400 font-medium hidden lg:block">&nbsp;</span>
          <div class="flex gap-2">
            <button
              type="submit"
              class="flex-1 inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-medium bg-sky-600 hover:bg-sky-500 active:bg-sky-700 text-white transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500/50"
            >
              Filter anwenden
            </button>
            <a
              href="/r_and_d"
              class="inline-flex items-center justify-center rounded-lg px-3 py-2 text-sm border border-slate-600 hover:bg-slate-800 hover:border-slate-500 text-slate-300 transition-colors"
              title="Alle Filter zur√ºcksetzen"
            >
              Reset
            </a>
          </div>
        </div>
      </div>

      {# Aktive Filter Badges + Result Count #}
      {% set has_active_filters = filters.preset or filters.strategy or filters.tag_substr or filters.with_trades %}
      {% if has_active_filters or experiments|length > 0 %}
      <div class="mt-4 pt-3 border-t border-slate-800/50 flex flex-wrap items-center gap-2">
        
        {# Result Count - immer anzeigen #}
        <span class="text-sm font-medium text-slate-200">
          {{ experiments|length }}
          {%- if experiments|length == 1 %} Experiment{% else %} Experimente{% endif %}
          {%- if has_active_filters %} gefunden{% endif %}
        </span>
        
        {% if has_active_filters %}
        <span class="text-slate-600 mx-1">¬∑</span>
        <span class="text-xs text-slate-400">Aktive Filter:</span>
        
        {# Filter Badges #}
        {% if filters.preset %}
        <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-sky-500/10 text-sky-300 border border-sky-500/30">
          preset: {{ filters.preset }}
        </span>
        {% endif %}
        
        {% if filters.strategy %}
        <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-purple-500/10 text-purple-300 border border-purple-500/30">
          strategy: {{ filters.strategy }}
        </span>
        {% endif %}
        
        {% if filters.tag_substr %}
        <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-amber-500/10 text-amber-300 border border-amber-500/30">
          tag: {{ filters.tag_substr }}
        </span>
        {% endif %}
        
        {% if filters.with_trades %}
        <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/30">
          nur mit Trades
        </span>
        {% endif %}
        
        {# Verh√§ltnis gefiltert/gesamt #}
        <span class="text-xs text-slate-500 ml-auto">
          ({{ filtered }} von {{ total }} gesamt)
        </span>
        {% endif %}
      </div>
      {% endif %}
    </form>
  </section>

  {# ======================================================================= #}
  {# SECTION 4: Experiments-Tabelle                                          #}
  {# ======================================================================= #}
  <section aria-label="Experiments-Tabelle">
    <div class="bg-slate-900/60 rounded-xl border border-slate-800 overflow-hidden">
      
      {# Empty State #}
      {% if experiments|length == 0 %}
      <div class="px-6 py-12 text-center">
        <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-slate-800 mb-4">
          <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </div>
        <h3 class="text-lg font-medium text-slate-200 mb-2">Keine Experimente gefunden</h3>
        {% if has_active_filters %}
        <p class="text-sm text-slate-400 mb-4 max-w-md mx-auto">
          Deine Filter haben keine Ergebnisse geliefert. Versuche weniger restriktive Kriterien oder setze die Filter zur√ºck.
        </p>
        <a
          href="/r_and_d"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-sky-600 hover:bg-sky-500 text-white text-sm font-medium transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Filter zur√ºcksetzen
        </a>
        {% else %}
        <p class="text-sm text-slate-400 max-w-md mx-auto">
          Stelle sicher, dass Experiment-JSONs in 
          <code class="bg-slate-800 px-1.5 py-0.5 rounded text-slate-300">reports/r_and_d_experiments/</code> 
          vorhanden sind.
        </p>
        {% endif %}
      </div>
      
      {% else %}
      {# Tabelle mit horizontalem Scroll auf kleinen Viewports #}
      <div class="overflow-x-auto">
        <table class="w-full text-sm min-w-[900px]">
          <thead class="bg-slate-900/90 text-slate-400 text-xs uppercase tracking-wider border-b border-slate-700/50 sticky top-0 z-10">
            <tr>
              <th class="px-4 py-3 text-left font-semibold whitespace-nowrap">Timestamp</th>
              <th class="px-4 py-3 text-left font-semibold whitespace-nowrap">Tag</th>
              <th class="px-4 py-3 text-left font-semibold whitespace-nowrap">Preset</th>
              <th class="px-4 py-3 text-left font-semibold whitespace-nowrap">Strategy</th>
              <th class="px-4 py-3 text-left font-semibold whitespace-nowrap">Symbol</th>
              <th class="px-4 py-3 text-right font-semibold whitespace-nowrap">Trades</th>
              <th class="px-4 py-3 text-right font-semibold whitespace-nowrap">Return</th>
              <th class="px-4 py-3 text-right font-semibold whitespace-nowrap">Sharpe</th>
              <th class="px-4 py-3 text-right font-semibold whitespace-nowrap">MaxDD</th>
              <th class="px-4 py-3 text-right font-semibold whitespace-nowrap">WinRate</th>
              <th class="px-4 py-3 text-center font-semibold whitespace-nowrap">Status</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800/50">
            {% for exp in experiments %}
            <tr class="hover:bg-slate-800/40 transition-colors {{ 'bg-slate-900/20' if loop.index is odd else '' }}">
              
              {# Timestamp #}
              <td class="px-4 py-2.5 font-mono text-xs text-slate-300 whitespace-nowrap">
                {{ exp.timestamp or '-' }}
              </td>

              {# Tag #}
              <td class="px-4 py-2.5 text-xs max-w-[180px]">
                {% if exp.tag %}
                <span class="truncate block text-slate-200" title="{{ exp.tag }}">
                  {{ exp.tag[:30] }}{{ '...' if exp.tag|length > 30 else '' }}
                </span>
                {% else %}
                <span class="text-slate-500">-</span>
                {% endif %}
              </td>

              {# Preset #}
              <td class="px-4 py-2.5 text-xs max-w-[160px]">
                {% if exp.preset_id %}
                <span class="truncate block text-sky-300" title="{{ exp.preset_id }}">
                  {{ exp.preset_id[:25] }}{{ '...' if exp.preset_id|length > 25 else '' }}
                </span>
                {% else %}
                <span class="text-slate-500">-</span>
                {% endif %}
              </td>

              {# Strategy #}
              <td class="px-4 py-2.5 text-xs max-w-[140px]">
                {% if exp.strategy %}
                <span class="truncate block text-purple-300" title="{{ exp.strategy }}">
                  {{ exp.strategy[:20] }}{{ '...' if exp.strategy|length > 20 else '' }}
                </span>
                {% else %}
                <span class="text-slate-500">-</span>
                {% endif %}
              </td>

              {# Symbol #}
              <td class="px-4 py-2.5 text-xs text-slate-300 whitespace-nowrap">
                {{ exp.symbol or '-' }}
              </td>

              {# Trades #}
              <td class="px-4 py-2.5 text-xs text-right tabular-nums">
                {% if exp.total_trades is not none %}
                  {% if exp.total_trades > 0 %}
                  <span class="text-emerald-300 font-medium">{{ exp.total_trades }}</span>
                  {% else %}
                  <span class="text-slate-500">0</span>
                  {% endif %}
                {% else %}
                <span class="text-slate-500">-</span>
                {% endif %}
              </td>

              {# Return #}
              <td class="px-4 py-2.5 text-xs text-right tabular-nums">
                {% if exp.total_return is not none %}
                  {% if exp.total_return >= 0 %}
                  <span class="text-emerald-300 font-medium">+{{ "%.2f%%"|format(exp.total_return * 100) }}</span>
                  {% else %}
                  <span class="text-rose-400 font-medium">{{ "%.2f%%"|format(exp.total_return * 100) }}</span>
                  {% endif %}
                {% else %}
                <span class="text-slate-500">-</span>
                {% endif %}
              </td>

              {# Sharpe - Farbcodierung nach Qualit√§t #}
              <td class="px-4 py-2.5 text-xs text-right tabular-nums">
                {% if exp.sharpe is not none %}
                  {% if exp.sharpe >= 1.5 %}
                  <span class="text-emerald-300 font-medium">{{ "%.2f"|format(exp.sharpe) }}</span>
                  {% elif exp.sharpe >= 0.5 %}
                  <span class="text-amber-300">{{ "%.2f"|format(exp.sharpe) }}</span>
                  {% elif exp.sharpe > 0 %}
                  <span class="text-slate-300">{{ "%.2f"|format(exp.sharpe) }}</span>
                  {% else %}
                  <span class="text-rose-400">{{ "%.2f"|format(exp.sharpe) }}</span>
                  {% endif %}
                {% else %}
                <span class="text-slate-500">-</span>
                {% endif %}
              </td>

              {# MaxDD #}
              <td class="px-4 py-2.5 text-xs text-right tabular-nums">
                {% if exp.max_drawdown is not none %}
                <span class="text-amber-300">{{ "%.1f%%"|format(exp.max_drawdown * 100) }}</span>
                {% else %}
                <span class="text-slate-500">-</span>
                {% endif %}
              </td>

              {# WinRate - Farbcodierung nach Qualit√§t #}
              <td class="px-4 py-2.5 text-xs text-right tabular-nums">
                {% if exp.win_rate is not none %}
                  {% if exp.win_rate >= 0.55 %}
                  <span class="text-emerald-300">{{ "%.1f%%"|format(exp.win_rate * 100) }}</span>
                  {% elif exp.win_rate >= 0.45 %}
                  <span class="text-slate-300">{{ "%.1f%%"|format(exp.win_rate * 100) }}</span>
                  {% else %}
                  <span class="text-rose-400">{{ "%.1f%%"|format(exp.win_rate * 100) }}</span>
                  {% endif %}
                {% else %}
                <span class="text-slate-500">-</span>
                {% endif %}
              </td>

              {# Status #}
              <td class="px-4 py-2.5 text-center">
                {{ status_badge(exp.status) }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# Pagination / Info Footer #}
      <div class="px-4 py-3 border-t border-slate-800/50 bg-slate-900/40 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <span class="text-xs text-slate-400">
          Zeige <span class="text-slate-200 font-medium">{{ experiments|length }}</span> von 
          <span class="text-slate-200">{{ total }}</span> Experimenten
          {% if filtered != total %}
          <span class="text-slate-500">({{ filtered }} nach Filter)</span>
          {% endif %}
        </span>
        <span class="text-xs text-slate-500">
          Limit: {{ limit }} ¬∑ Sortiert nach Timestamp (neueste zuerst)
        </span>
      </div>
      {% endif %}
    </div>
  </section>

  {# ======================================================================= #}
  {# SECTION 5: Footer-Hinweis                                               #}
  {# ======================================================================= #}
  <footer class="text-xs text-slate-500 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 pt-2">
    <p class="flex items-center gap-1">
      <span>üí°</span>
      <span>R&D Dashboard v0 ‚Äì Read-only View ¬∑ Phase 76</span>
    </p>
    <p class="flex flex-wrap items-center gap-2">
      <span>API:</span>
      <code class="bg-slate-800 px-1.5 py-0.5 rounded text-slate-400">/api/r_and_d/experiments</code>
      <span class="text-slate-600">¬∑</span>
      <code class="bg-slate-800 px-1.5 py-0.5 rounded text-slate-400">/api/r_and_d/stats</code>
    </p>
  </footer>

</div>
{% endblock %}
